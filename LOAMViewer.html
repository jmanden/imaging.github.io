<!DOCTYPE html>
<html>
<head>
    
     <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=0.5, user-scalable=no">	
 <meta name="apple-mobile-web-app-capable" content="yes">    
 <meta name="mobile-web-app-capable" content="yes">
    
    <script src="accessories/papaparse.min.js"></script> 
    <script src="accessories/shapiro-wilk.js"></script>
    <script src="accessories/statistics-distributions.js"></script>
    <script src="accessories/statFunctions.js"></script>
    <script src="accessories/jstat.min.js"></script>
    
  
    
    
    <style>
    
  body { margin:0px;overflow:hidden;}    
        
        
  .alignleft {
	float: left;
}
.alignright {
	float: right;
}
  
  /* highlight table */          
  #scrolltable1 { margin-top: 0px; height: 20px; width: 530;  position: absolute; border: 1px solid #f3f2f2; top: 520px; left: 480px; z-index: 10}
  #scrolltableheader1 {padding: 0px;cursor: move;z-index: 10;background-color: black;color: #fff;}
  #tableText1 { overflow: auto; height: 400px; width: 600px; font-size: 11px;overflow-x: scroll;white-space: nowrap;background: #ffffff; border: 1px solid #f3f2f2}
  
  /* subject table */
  #scrolltable3 { margin-top: 0px; height: 20px; width: 530;  position: absolute; border: 1px solid #f3f2f2; top: 0px; left: 1010px; z-index: 10}
  #scrolltableheader3 {padding: 0px;cursor: move;z-index: 10;background-color: black;color: #fff;}
  #tableText3 { overflow: auto; height: 500px; width: 600px; font-size: 11px;overflow-x: scroll;white-space: nowrap;background: #ffffff;border: 1px solid #f3f2f2}
 
  /* observer */
  #scrolltable4 { margin-top: 0px; height: 20px; width: 400;  position: absolute; border: 1px solid #f3f2f2; top: 90px; left: 480px; z-index: 10}
  #scrolltableheader4 {padding: 0px;cursor: move;z-index: 10;background-color: black;color: #fff;}
  #tableText4 { overflow: auto; height: 300px; width: 500px; font-size: 11px;overflow-x: scroll;white-space: nowrap;background: #ffffff;border: 1px solid #f3f2f2}

 /* toggle observer table */
 #scrolltable2 { margin-top: 0px; height: 20px; width: 400;  position: absolute; border: 1px solid #f3f2f2; top: 40px; left: 1010px; z-index: 10; display: none;}
  #scrolltableheader2 {padding: 0px;cursor: move;z-index: 10;background-color: black;color: #fff;}
  #tableText2 { overflow: auto; height: 300px; width: 400px; font-size: 11px;overflow-x: scroll;white-space: nowrap;background: #ffffff;border: 1px solid #f3f2f2}

  /* toolbar */
  #scrolltable5 { margin-top: 0px; height: 20px; width: 400;  position: absolute; border: 1px solid #f3f2f2; top: 0px; left: 0px; z-index: 10}
  #scrolltableheader5 {padding: 0px;cursor: move;z-index: 10;background-color: black;color: #fff;}
  #tableText5 { text-align: center;overflow: none; height: 70px; width: 850px; font-size: 13px;overflow-x: none;white-space: nowrap;background: #ffffff;border: 1px solid #f3f2f2}

 /* observer */
  #scrolltable6 { margin-top: 0px; height: 20px; width: 400;  position: absolute; border: 1px solid #f3f2f2; top: 490px; left: 0px; z-index: 10}
  #scrolltableheader6 {padding: 0px;cursor: move;z-index: 10;background-color: black;color: #fff;}
  #tableText6 { overflow: auto; height: 300px; width: 500px; font-size: 11px;overflow-x: scroll;white-space: nowrap;background: #ffffff;border: 1px solid #f3f2f2}

 
 #scrolltableInterobserver { margin-top: 20px; height: 200px; width: 350px; overflow: auto; position: inline-block;
  border: 1px solid #d3d3d3;font-size: 13px;}
#scrolltableInterobserver table { border-collapse: collapse; font-size: 13px}
#scrolltableInterobserver tr:nth-child(even) { background: #EEE; }
#scrolltableInterobserver th div { position: absolute; margin-top: -20px; }


a {
  color: black;
}        


#LoAField {
  position: absolute;
  top: 200px;
  left: 200px;
  width: 530px;
  background-color: white;
  opacity: 1.0;
  z-index: 1000;
  visibility:hidden;
  
}

#imageBox {
  position: absolute;
  top: 200px;
  left: 200px;
  z-index: 1010
  
}


.tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 520px;
  background-color: black;
  color: #fff;
  text-align: left;
  border-radius: 5px;
  padding: 15px;
  padding-left: 15px;
  padding-right: 25px;
  
  
  ;

  /* Position the tooltip */
  position: absolute;
  z-index: 1;
  left: 10%;
  margin-left: -260px;
  
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  cursor: pointer;
}

</style>
    
  
    
</head>    
    
<body onload="setupGUI()">
    



<canvas id="myCanvas" width="1200" height="800" style="border:0px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>


<br>
<br>

<!--
Interobserver agreement plot.<br>
Horizontal axes represent average, vertical axes represent difference from the mean. Individual measurements of observers represented by black dots. Note some dots have been superimposed.<br>
Horizontal lines indicate upper and lower limits of agreement with the mean and a line of zero difference. Dashed lines correspond to the confidence intervals for the limits of agreement. 
-->

<div id="LoAField">
<fieldset style="width:500px">
  <legend>Bland-Altman Limits of Agreement Calculator:</legend>
    First set of measurements:<br>
    <select id="observerDropdown" size="1"></select><select id="measurementDropdown" size="1"></select><br>
    Second set of measurements:<br>
   <select id="observerDropdown2" size="1"></select><select id="measurementDropdown2" size="1"></select>
   <br><br>
   <button onClick="javascript:LoACalc(-1,-1,-1,-1)">Calculate one LoA pair</button><span id="LoAResult"></span>
   <br><br>
   <!--<button id="intraObserverButton" onClick="javascript:generateLoAsIntra()">Intraobserver agreement between pairs</button>
   <br><br>-->
   <button id="interObserverButton" onClick="javascript:generateLoAsInter()">Interobserver agreement between pairs (n=x)</button>
   
   <div id="scrolltableInterobserver">
    <table id="realTableInterobserver">
        
        
        
    </table>
</div>
</fieldset>
</div>


<div id="scrolltable1">
  <div id="scrolltableheader1">
      
      <span class="alignleft">Highlighted measurements</span>
      <span class="alignright">
          
             <div class="tooltip"><span class="tooltiptext" id="tooltiptextHighlighted">Tooltip text</span><img onmouseover="" style="cursor: pointer; vertical-align: baseline;" src="img/infoIcon.png" height="16"></div>
          
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText1', this,1)" src="img/plus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText1', this,-1)" src="img/minus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:minimizeGUE('tableText1', this)" src="img/minimize.png" height="16">
      </span>
<div style="clear: both;"></div>
      
  </div>
    <div id="tableText1" onmouseup="endResize()">
    </div>
    
</div>


<div id="scrolltable3">
  <div id="scrolltableheader3">
      <span class="alignleft">Subjects</span>
      <span class="alignright">
            <div class="tooltip"><span class="tooltiptext" id="tooltiptextSubjects">Tooltip text</span><img onmouseover="" style="cursor: pointer; vertical-align: baseline;" src="img/infoIcon.png" height="16"></div>
       
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText3', this,1)" src="img/plus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText3', this,-1)" src="img/minus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:minimizeGUE('tableText3', this)" src="img/minimize.png" height="16">
      </span>
<div style="clear: both;"></div>
  </div>
    <div id="tableText3">
    </div>
</div>


<div id="scrolltable4">
  <div id="scrolltableheader4">
      
    <span class="alignleft">Observers</span>
      <span class="alignright">
      
          <div class="tooltip"><span class="tooltiptext" id="tooltiptextObservers">Tooltip text</span><img onmouseover="" style="cursor: pointer; vertical-align: baseline;" src="img/infoIcon.png" height="16"></div>
       
  

          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText4', this,1)" src="img/plus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText4', this,-1)" src="img/minus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:minimizeGUE('tableText4', this)" src="img/minimize.png" height="16">
      </span>
<div style="clear: both;"></div>
     
  
  
  </div>
    <div id="tableText4">
    </div>
</div>


<div id="scrolltable2">
  <div id="scrolltableheader2">
      
        <span class="alignleft">Toggle observers</span>
      <span class="alignright">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText2', this,1)" src="img/plus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText2', this,-1)" src="img/minus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:minimizeGUE('tableText2', this)" src="img/minimize.png" height="16">
      </span>
<div style="clear: both;"></div>
     
  
  
  
  </div>
    <div id="tableText2">
    </div>
</div>

<div id="scrolltable6">
  <div id="scrolltableheader6">
      
        <span class="alignleft">LOAM info</span>
      <span class="alignright">
          
            <div class="tooltip"><span class="tooltiptext" id="tooltiptextLOAMInfo">Tooltip text</span><img onmouseover="" style="cursor: pointer; vertical-align: baseline;" src="img/infoIcon.png" height="16"></div>
       
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText6', this,1)" src="img/plus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText6', this,-1)" src="img/minus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:minimizeGUE('tableText6', this)" src="img/minimize.png" height="16">
      </span>
<div style="clear: both;"></div>
     
  
  
  
  </div>
    <div id="tableText6">
    </div>
</div>



<div id="scrolltable5">
  <div id="scrolltableheader5">
      
        <span class="alignleft">Toolbar</span>
      <span class="alignright">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText5', this,1)" src="img/plus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:fontSize('tableText5', this,-1)" src="img/minus.png" height="16">
          <img onmouseover="" style="cursor: pointer; vertical-align: baseline;" onmousedown="javascript:minimizeGUE('tableText5', this)" src="img/minimize.png" height="16">
      </span>
<div style="clear: both;"></div>
  
  
  
  
  
  
  </div>
    <div id="tableText5">
        
        <!--<button onclick="estimateHalfWidth()">Estimate number of observers for certain CI half-width</button>-->
<!--<button onclick="estimateWidth()">Estimate number of observers for certain CI width</button>-->
    
<input type="file" style="display:none" name="File Upload" id="txtFileUpload" accept=".csv" /> 

<!--<button onclick="generatePear()">Calculate Pearson's correlation coefficients</button>-->

<button onclick="toggleLoA()">Toggle LoA calculator</button>

<span>Sort subjects: <select id="sortByDropdown" size="1" onchange="sortBy()">
    <option value="subject">Subject</option>
  <option value="mean">Mean</option>
  <option value="meanSD">SD (differences from the mean)</option>
</select></span>

<br>

<span>Sort highlighted: <select id="sortByDropdownHighlighted" size="1" onchange="sortByHighlighted()">
     <option value="subject">Subject</option>
    <option value="measurement">Measurement</option>
  <option value="diffMean">Difference from the mean</option>
  <option value="observer">Observer</option>
</select></span>

<span>Sort observers: <select id="sortByDropdownObservers" size="1" onchange="sortByObservers()">
     <option value="observer">Observer</option>
    <option value="mean">Mean</option>
  <option value="meanDiff">Mean of differences from the mean</option>
   <option value="SDDiff">SD (mean)</option>
</select></span>


<span></span><input type="range" id="outlierRange" title="Highlight measurement differences from subject mean greater than ->" name="outlierRange" min="0" max="100" value="20" /> <span id="outputOutlierRange">20</span>

        
        
    </div>
</div>



<div id = "imageBox" onClick="javascript:removeImageBox()"></div>

</body>

</html>



<script>

function setupGUI() {
  
    if (getParameterByName("title") != null)
        document.title = getParameterByName("title");
  
    // Highlighted measurements
    document.getElementById("tableText1").style.width = "600px";
    var str = document.getElementById("tableText1").style.width; 
    str = parseInt(str.substring(0, str.length - 2));
    document.getElementById("scrolltable1").style.left = (window.innerWidth-str)+"px";
    
    // Observers
    document.getElementById("tableText4").style.width = "500px";
    var str = document.getElementById("tableText4").style.width; 
    str = parseInt(str.substring(0, str.length - 2));
    document.getElementById("scrolltable4").style.left = (window.innerWidth-(str+600))+"px";
    
    // Subjects
    document.getElementById("tableText3").style.width = "600px";
    var str = document.getElementById("tableText3").style.width; 
    str = parseInt(str.substring(0, str.length - 2));
    document.getElementById("scrolltable3").style.left = (window.innerWidth-str)+"px";
    
    // Top toolbar
    document.getElementById("tableText5").style.width = "850px"; 
    var str2 = document.getElementById("tableText5").style.width; 
    str2 = parseInt(str2.substring(0, str2.length - 2));
    document.getElementById("scrolltable5").style.left = (window.innerWidth-(str2+str))+"px";
   
   
    document.getElementById("scrolltable6").style.left = 0+"px";
    document.getElementById("tableText6").style.height = 250+"px";
    document.getElementById("scrolltable6").style.top = (window.innerHeight-270)+"px";
    
    
    var tempText = "";
    
    tempText = "";
    tempText += "<ul>";
    tempText += "<li>Mean: mean of all measurements by observer j and standard deviation in parentheses</li>";
    tempText += "<li>Mean difference: mean of differences from the mean of all measurements by observer j</li>";
    //tempText += "<li>The line of your observer information is in bold</li>";
    tempText += "</ul>";
    
    document.getElementById("tooltiptextObservers").innerHTML = tempText;
    
    tempText = "";
    tempText += "<ul>";
    tempText += "<li>Diff mean: difference from the subject-specific (i) mean of the observed measurement by observer j</li>";
    //tempText += "<li>Angle: angulation of the caliper placement, i.e. horizontally aligned caliper = 0 degrees, vertically aligned caliper = 90 degrees</li>";
    //tempText += "<li>Z-pos: z-position of the placed caliper</li>";
    tempText += "<li>Screenshot: show screenshot of the placed caliper by observer j on subject i</li>";
    //tempText += "<li>Screenshot: show screenshots of all 4 pancreatic measurmements performed by observer j in round k on subject i</li>";
  
  
    tempText += "</ul>";
    
    document.getElementById("tooltiptextHighlighted").innerHTML = tempText;
    
    
    tempText = "";
    tempText += "<ul>";
    tempText += "<li>Mean: mean of all measurements performed on subject i and standard deviation</li>";
    tempText += "<li>SD: standard deviation of the measurement differences from the mean of subject i by all b observers</li>";
    
    
    //tempText += "<li>Mean angle diff: mean angle difference between observer pairs of caliper placements by all observers for subject i</li>";
    //tempText += "<li>Mean midpoint dist: the mean distance between observer pairs of the x-y-z midpoint caliper placements by all observers for subject i</li>";
    //tempText += "<li>Show screenshots: show screenshots of all caliper placements on subject i</li>";
    //tempText += "<li>Open study: open DICOM study with calipers of subject i</li>";
    
    tempText += "</ul>";
    
    
    document.getElementById("tooltiptextSubjects").innerHTML = tempText;
    
    
    
    tempText = "";
    tempText += "<ul>";
    tempText += "<li>b: number of observers</li>";
    tempText += "<li>a: number of subjects</li>";
    tempText += "<li>c: number of measurements per observer per subject</li>";
    tempText += "<li>The 95% limits of agreement with the mean (LOAM) represents the expected measurement deviation of a given observer from the mean of all the measurements of observers on a given subject, i.e. a measure of the combined inter- and intraobserver variation</li>";
    tempText += "<li>c: number of measurements per observer per subject</li>";
    tempText += "<li>d<sub>ij</sub> is the observed difference, i.e. the observed measurement (y<sub>ij</sub>) minus the observed subject-specific average (<span style='text-decoration: overline'>y</span><sub>ij</sub>)</li>";
    tempText += "<li>Constructing an agreement plot entails plotting the observed differences against the observed subject-specific averages</li>";
    tempText += "<li>&#963;<sub>A</sub>: inter-subject variance component</li>";
    tempText += "<li>&#963;<sub>B</sub>: inter-observer variance component</li>";
    tempText += "<li>&#963;<sub>E</sub>: intra-observer variance component</li>";
    tempText += "</ul>";
    



    document.getElementById("tooltiptextLOAMInfo").innerHTML = tempText;
    
    
    
}


function endResize() {
    
   //document.getElementById("scrolltable1").style.height = document.getElementById("tableText1").style.height;
 
}


// font-size: 13px

function fontSize(ref, obj, which) {
        if (which > 0)
            document.getElementById(ref).style.fontSize = (parseInt(document.getElementById(ref).style.fontSize)+1)+"px";
        else
            document.getElementById(ref).style.fontSize = (parseInt(document.getElementById(ref).style.fontSize)-1)+"px";
        
}

function minimizeGUE(ref, obj) {
    var element = document.getElementById(ref).style.display;
    if (document.getElementById(ref).style.display == "none") {
        document.getElementById(ref).style.display = "block";
        obj.src = "img/minimize.png";
        
    }
    else {
        document.getElementById(ref).style.display = "none";
        obj.src = "img/maximize.png";
    }
    
    
}


dragElement(document.getElementById("scrolltable4"),"scrolltable",4);
dragElement(document.getElementById("scrolltable1"),"scrolltable",1);
dragElement(document.getElementById("scrolltable3"),"scrolltable",3);
dragElement(document.getElementById("scrolltable2"),"scrolltable",2);
dragElement(document.getElementById("scrolltable5"),"scrolltable",5);
dragElement(document.getElementById("scrolltable6"),"scrolltable",6);


document.getElementById("tableText1").style.resize = "both";
document.getElementById("tableText3").style.resize = "both";
document.getElementById("tableText4").style.resize = "both";
document.getElementById("tableText2").style.resize = "both";
document.getElementById("tableText6").style.resize = "both";


document.getElementById("tableText1").style.fontSize = "11px";
document.getElementById("tableText2").style.fontSize = "11px";
document.getElementById("tableText3").style.fontSize = "11px";
document.getElementById("tableText4").style.fontSize = "11px";
document.getElementById("tableText6").style.fontSize = "11px";


var moveGUI = false;
var maxGUIZ = 10;
function dragElement(elmnt,id, no) {
    
  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  if (document.getElementById(id + "header"+no)) {
    /* if present, the header is where you move the DIV from:*/
    document.getElementById(id + "header"+no).onmousedown = dragMouseDown;
  } else {
    /* otherwise, move the DIV from anywhere inside the DIV:*/
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    
    maxGUIZ++;
    elmnt.style.zIndex = maxGUIZ;
  
    moveGUI = true;  
    //console.log("mouseDown"+e);   
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
   // console.log("moveIT"+e);  
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    
    moveGUI = false;
    plot.moveFig = false;
    plot.resizeFig = false;
    /* stop moving when mouse button is released:*/
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
</script>







<script>



can = document.getElementById("myCanvas");
ctx = can.getContext("2d");


var participant = "";
var plot;

var histogram = new Object();

//var shapiroWilksArr = new Array();
//ctx.fillText("Shapiro-Wilk test of differences from the mean, p: "+shapiroWilksArr[shapiroWilksArr.length-1], histogram.x+histogram.xAxisLength+10, histogram.y-histogram.yAxisLength);


var message;
var mousePos;
var CI;
var preprocessed = false;


var a, b, c;

var dataMatrixBBC = new Array();

function resetDefault() {

// j = observers, i = subjects
dataMatrixBBC = new Array();
dataMatrixBBC.meanYj = new Array();

dataMatrixBBC.meanYi = new Array();
dataMatrixBBC.meanYiSD = new Array();


dataMatrixBBC.meanYi0 = new Array();
dataMatrixBBC.meanYi1 = new Array();

dataMatrixBBC.grandMean = 0;


dataMatrixBBC.meanYMin = 1000000000;
dataMatrixBBC.meanYMax = -1000000000;


dataMatrixBBC.grandMin = 1000000000;
dataMatrixBBC.grandMax = -1000000000;

dataMatrixBBC.d_ijMax = -1000000000;
dataMatrixBBC.d_ijMin = 1000000000;


dataMatrixBBC.rangeDiff; // range of differences

dataMatrixBBC.diffDistribution2 = new Array(1000).fill(0);
dataMatrixBBC.diffDistributionSelectedObserver = new Array(50).fill(0);

}
//preprocessing();




function preprocessing() {
    
    can.width  = window.innerWidth;
    can.height = window.innerHeight;
    
    
    resetDefault();

if (true) {
    
    c = 1;
    if (getParameterByName("c") != null)
        c = parseInt(getParameterByName("c"));
    
    m = parseInt(getParameterByName("m"));
    a = data.data.length-1;
    b = (data.data[0].length)/c;
    populateDropdown(b, c);
    
    
    
   var counterB = 0;
   
   
    for (j=0;j<b;j++) {
     //if (j<2 || j > 10) 
       // continue;
        if (observerList[j] == 0)
            continue;
      
        dataMatrixBBC[counterB] = new Array();
        
        
        for(i=0;i<a;i++) {
            
          
            dataMatrixBBC[counterB][i] = [[], [null], "Observer "+(j+1),[],[],[]]; // measurements, d_ijk, "observer", angle, midpoint, z-pos 
            
            
            
            for(k=0;k<c;k++) {
            
            dataMatrixBBC[counterB][i][0].push(parseFloat(data.data[i][j*c+k]));
            
                if (data3 != null && true) {
                    
                    var tempDataAngle = data3.data[i][j*c+k].split(":").map(parseFloat);
                    
                    //data3.data[no].map(x => x.split(":").map(parseFloat));
                    
                    var angleCaliper = -(Math.atan2(tempDataAngle[3]-tempDataAngle[1], tempDataAngle[2]-tempDataAngle[0]) * 180 / Math.PI);
                    
                    if (angleCaliper > 90) {
                        angleCaliper = -(180-angleCaliper);
                    }
                    if (angleCaliper < -90) {
                        angleCaliper = (180+angleCaliper);
                    }
                    var lineMidpoint = [(tempDataAngle[0]+tempDataAngle[2])/2,(tempDataAngle[1]+tempDataAngle[3])/2,tempDataAngle[4]];
                
                   
                    dataMatrixBBC[counterB][i][3].push(angleCaliper);
                    dataMatrixBBC[counterB][i][4].push(lineMidpoint);
                     dataMatrixBBC[counterB][i][5].push(tempDataAngle[4]);
                    // sigil
                }
            
                
            }
            
        }
         
     counterB++;
     
    }
    b = counterB;
    
    if (data3 != null && true)
        avgMidpointDist();
    
    
}
else if (false) {
    n = 4;
    m = 6;
    b = 4;
    a = 6;
    
    dataMatrixBBC[0] = new Array();
     dataMatrixBBC[1] = new Array();
     dataMatrixBBC[2] = new Array();
     dataMatrixBBC[3] = new Array();
    var all = new Array();
    all[0] = [9,6,8,7,10,6];
    all[1] = [2,1,4,1,5,2];
    all[2] = [5,3,6,2,6,4];
    all[3] = [8,2,8,6,9,7];
    
    
    for (i=0;i<b;i++) {
           
        for(j=0;j<a;j++) {
            
            dataMatrixBBC[i][j] = [all[i][j]+(Math.random()*0),null,"Judge "+(i+1)];
        
        } 
     
    }
    
}

else {
    b = 20;
    a = 40;
    n = b;
    m = a;
// generate dataset
for(i=0;i<b;i++) {
     dataMatrixBBC[i] = new Array();
     
    for(j=0;j<a;j++) 
    {
        
        
        dataMatrixBBC[i][j] = [10+j+(-i*4+Math.random()*i*8),null,"Radiologist "+(i+1)]; // y_ij, d_ij; d_ij = y_ij-y_j
        
    }
}

}


populateObserverTable();


// BBC

// meanYj
for(j=0;j<b;j++) {
    dataMatrixBBC.meanYj[j] = 0;
    
    for(i=0;i<a;i++) {
        for(k=0;k<c;k++) {
            dataMatrixBBC.meanYj[j] = dataMatrixBBC.meanYj[j] + dataMatrixBBC[j][i][0][k];
            dataMatrixBBC.grandMean = dataMatrixBBC.grandMean + dataMatrixBBC[j][i][0][k];
        }    
    }
    dataMatrixBBC.meanYj[j] = dataMatrixBBC.meanYj[j] / (a*c);
    
}
dataMatrixBBC.grandMean = dataMatrixBBC.grandMean / (a*b*c);


// meanYi
for(i=0;i<a;i++) {
    dataMatrixBBC.meanYi[i] = 0;
    dataMatrixBBC.meanYi0[i] = 0;
    dataMatrixBBC.meanYi1[i] = 0;
    
    
    for(j=0;j<b;j++) {
        
        for(k=0;k<c;k++) {
        
            dataMatrixBBC.meanYi[i] = dataMatrixBBC.meanYi[i] + dataMatrixBBC[j][i][0][k];
            
            if (k == 0)
                dataMatrixBBC.meanYi0[i] = dataMatrixBBC.meanYi0[i] + dataMatrixBBC[j][i][0][k];
            if (k == 1)
                dataMatrixBBC.meanYi1[i] = dataMatrixBBC.meanYi1[i] + dataMatrixBBC[j][i][0][k];
            
            if (dataMatrixBBC[j][i][0][k] >= dataMatrixBBC.grandMax)
            dataMatrixBBC.grandMax = dataMatrixBBC[j][i][0][k];         
         
            if (dataMatrixBBC[j][i][0][k] <= dataMatrixBBC.grandMin)
            dataMatrixBBC.grandMin = dataMatrixBBC[j][i][0][k];
            
        }
        
        
        
        
    }
    dataMatrixBBC.meanYi[i] = dataMatrixBBC.meanYi[i] / (b*c);
    dataMatrixBBC.meanYi0[i] = dataMatrixBBC.meanYi0[i] / b;
    dataMatrixBBC.meanYi1[i] = dataMatrixBBC.meanYi1[i] / b;
    
    
     if (dataMatrixBBC.meanYi[i] >= dataMatrixBBC.meanYMax)
        dataMatrixBBC.meanYMax = dataMatrixBBC.meanYi[i];
     if (dataMatrixBBC.meanYi[i] <= dataMatrixBBC.meanYMin)
        dataMatrixBBC.meanYMin = dataMatrixBBC.meanYi[i];
   
   
    
    
   
    dataMatrixBBC.meanYiSD[i] = 0;
    for(j=0;j<b;j++) {
        
        for(k=0;k<c;k++) {
           
           dataMatrixBBC.meanYiSD[i] += Math.pow(dataMatrixBBC[j][i][0][k]-dataMatrixBBC.meanYi[i],2);
    
           
        }
    }    
    dataMatrixBBC.meanYiSD[i] = Math.sqrt(dataMatrixBBC.meanYiSD[i] / (b*c-1));

}

// d_ij
for(j=0;j<b;j++) {
    
    dataMatrixBBC[j].meanD_j = 0; // mean difference observer j 
    dataMatrixBBC[j].SD = 0;
    
    
    dataMatrixBBC[j].max = -1000000000;
    dataMatrixBBC[j].min = 1000000000;
    
    for(i=0;i<a;i++) {
        
        
        for(k=0;k<c;k++) {
        
            var d_ijk = dataMatrixBBC[j][i][0][k]-dataMatrixBBC.meanYi[i];
            dataMatrixBBC[j][i][1][k] = d_ijk; // = d_ij
            
            dataMatrixBBC[j].meanD_j += dataMatrixBBC[j][i][1][k];
           // if (j==1)
             //   console.log(i+" : "+dataMatrixBBC[j].meanD_j);
            
            if (dataMatrixBBC[j][i][0][k] > dataMatrixBBC[j].max)       
                dataMatrixBBC[j].max = dataMatrixBBC[j][i][0][k];
            if (dataMatrixBBC[j][i][0][k] < dataMatrixBBC[j].min)       
                dataMatrixBBC[j].min = dataMatrixBBC[j][i][0][k];
                
            if (d_ijk >= dataMatrixBBC.d_ijMax)
                dataMatrixBBC.d_ijMax = d_ijk;         
            if (d_ijk <= dataMatrixBBC.d_ijMin)
                dataMatrixBBC.d_ijMin = d_ijk;          
           
           dataMatrixBBC[j].SD += Math.pow(dataMatrixBBC[j][i][0][k]-dataMatrixBBC.meanYj[j],2);
        }
        
       
        
    }

    
    dataMatrixBBC[j].SD = Math.sqrt(dataMatrixBBC[j].SD / ((a*c)-1));
    
    dataMatrixBBC[j].meanD_j = dataMatrixBBC[j].meanD_j / (a*c);
    

}

dataMatrixBBC.rangeDiff = dataMatrixBBC.d_ijMax-dataMatrixBBC.d_ijMin;

setOutlierRange();


for(j=0;j<b;j++) {

    for(i=0;i<a;i++) {

        for(k=0;k<c;k++) {

            var diffRatio = ((dataMatrixBBC[j][i][1][k]-dataMatrixBBC.d_ijMin)/dataMatrixBBC.rangeDiff)*50;
           
            dataMatrixBBC.diffDistribution2[Math.floor(diffRatio)]++;

        }
    }

}



// calculate SSB
dataMatrixBBC.SSB = 0;
for(j=0;j<b;j++) {

    dataMatrixBBC.SSB = dataMatrixBBC.SSB + Math.pow(dataMatrixBBC.meanYj[j]-dataMatrixBBC.grandMean, 2);

}

dataMatrixBBC.SSB = dataMatrixBBC.SSB * a * c;


// calculate SSE and SSW
dataMatrixBBC.SSE = 0;
dataMatrixBBC.SSW = 0;
for(i=0;i<a;i++) {
    for(j=0;j<b;j++) {
        for(k=0;k<c;k++) {
            dataMatrixBBC.SSE = dataMatrixBBC.SSE + Math.pow(dataMatrixBBC[j][i][0][k]-dataMatrixBBC.meanYi[i]-dataMatrixBBC.meanYj[j]+dataMatrixBBC.grandMean,2);
        
            dataMatrixBBC.SSW = dataMatrixBBC.SSW + Math.pow(dataMatrixBBC[j][i][0][k]-dataMatrixBBC.meanYi[i], 2); 
            
        }
        
    }
    
}

// calculate SSA
dataMatrixBBC.SSA = 0;
for(i=0;i<a;i++) {

    dataMatrixBBC.SSA = dataMatrixBBC.SSA + Math.pow(dataMatrixBBC.meanYi[i]-dataMatrixBBC.grandMean,2);
        
}
dataMatrixBBC.SSA = dataMatrixBBC.SSA * b *c;

dataMatrixBBC.LOAM = 1.96*Math.sqrt((dataMatrixBBC.SSB+dataMatrixBBC.SSE)/(a*b*c));

dataMatrixBBC.LOAM_observerRemoved = 1.96*Math.sqrt((dataMatrixBBC.SSW)/(a*b*c));

dataMatrixBBC.V_B = b - 1;
dataMatrixBBC.V_E = a*b*c-a-b+1;
dataMatrixBBC.V_W = a*(b*c-1);
dataMatrixBBC.V_A = a - 1;

dataMatrixBBC.MSB = dataMatrixBBC.SSB/dataMatrixBBC.V_B;

dataMatrixBBC.MSE = dataMatrixBBC.SSE/dataMatrixBBC.V_E;

dataMatrixBBC.MSA = dataMatrixBBC.SSA/(dataMatrixBBC.V_A);


dataMatrixBBC.SIGMA_B_2 = ((dataMatrixBBC.MSB-dataMatrixBBC.MSE)/(a*c)); // 0.29
dataMatrixBBC.SIGMA_E_2 = (dataMatrixBBC.MSE); // 0.58
dataMatrixBBC.SIGMA_A_2 = ((dataMatrixBBC.MSA-dataMatrixBBC.MSE)/(b*c)); 

//if (dataMatrixBBC.SIGMA_B_2 < 0)
  //  dataMatrixBBC.SIGMA_B_2 = 0;

dataMatrixBBC.SIGMA_B = Math.sqrt(dataMatrixBBC.SIGMA_B_2);
dataMatrixBBC.SIGMA_E = Math.sqrt(dataMatrixBBC.SIGMA_E_2);
dataMatrixBBC.SIGMA_A = Math.sqrt(dataMatrixBBC.SIGMA_A_2);


//dataMatrixBBC.LOAM = 1.96*Math.sqrt(((b-1)/b)*dataMatrixBBC.SIGMA_B_2+((b*c-1)/(b*c))*dataMatrixBBC.SIGMA_E_2);


dataMatrixBBC.SIGMA_E_CI = 1.96*(dataMatrixBBC.SIGMA_E/Math.sqrt(2*dataMatrixBBC.V_E));
dataMatrixBBC.SIGMA_B_CI = (1.96/(a*dataMatrixBBC.SIGMA_B)) * Math.sqrt((Math.pow(a*dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2, 2)/(2*dataMatrixBBC.V_B))+(Math.pow(dataMatrixBBC.SIGMA_E_2,2)/(2*dataMatrixBBC.V_E)));


dataMatrixBBC.l_B = 1-(1/qf(0.975,dataMatrixBBC.V_B,10e6,10e6));
dataMatrixBBC.l_E = 1-(1/qf(0.975,dataMatrixBBC.V_E,10e6,10e6));

dataMatrixBBC.h_B = (1/qf(0.025,dataMatrixBBC.V_B,10e6,10e6))-1;
dataMatrixBBC.h_E = (1/qf(0.025,dataMatrixBBC.V_E,10e6,10e6))-1;


dataMatrixBBC.L = Math.sqrt(dataMatrixBBC.l_B*dataMatrixBBC.l_B*dataMatrixBBC.SSB*dataMatrixBBC.SSB+dataMatrixBBC.l_E*dataMatrixBBC.l_E*dataMatrixBBC.SSE*dataMatrixBBC.SSE);

dataMatrixBBC.H = Math.sqrt(dataMatrixBBC.h_B*dataMatrixBBC.h_B*dataMatrixBBC.SSB*dataMatrixBBC.SSB+dataMatrixBBC.h_E*dataMatrixBBC.h_E*dataMatrixBBC.SSE*dataMatrixBBC.SSE);

dataMatrixBBC.LOAM_CI2 = [1.96*Math.sqrt((dataMatrixBBC.SSB+dataMatrixBBC.SSE-dataMatrixBBC.L)/(a*b*c)),1.96*Math.sqrt((dataMatrixBBC.SSB+dataMatrixBBC.SSE+dataMatrixBBC.H)/(a*b*c))];

dataMatrixBBC.SIGMA_E_CI2 = [dataMatrixBBC.SIGMA_E*Math.sqrt(dataMatrixBBC.V_E/qchisq(0.025,dataMatrixBBC.V_E,1)),dataMatrixBBC.SIGMA_E*Math.sqrt(dataMatrixBBC.V_E/qchisq(0.975,dataMatrixBBC.V_E,1))]; 


dataMatrixBBC.SIGMA_A_CI = [];
dataMatrixBBC.SIGMA_A_CI[0] = dataMatrixBBC.SIGMA_A-(1.96/(b*dataMatrixBBC.SIGMA_A))*Math.sqrt((Math.pow(b*dataMatrixBBC.SIGMA_A*dataMatrixBBC.SIGMA_A+dataMatrixBBC.SIGMA_E*dataMatrixBBC.SIGMA_E,2)/(2*dataMatrixBBC.V_A))+((dataMatrixBBC.SIGMA_E*dataMatrixBBC.SIGMA_E)/(2*dataMatrixBBC.V_E)));
dataMatrixBBC.SIGMA_A_CI[1] = dataMatrixBBC.SIGMA_A+(1.96/(b*dataMatrixBBC.SIGMA_A))*Math.sqrt((Math.pow(b*dataMatrixBBC.SIGMA_A*dataMatrixBBC.SIGMA_A+dataMatrixBBC.SIGMA_E*dataMatrixBBC.SIGMA_E,2)/(2*dataMatrixBBC.V_A))+((dataMatrixBBC.SIGMA_E*dataMatrixBBC.SIGMA_E)/(2*dataMatrixBBC.V_E)));


dataMatrixBBC.ICC = dataMatrixBBC.SIGMA_A_2/(dataMatrixBBC.SIGMA_A_2+dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2); 


//dataMatrixBBC.LOAM_CI = 0;
//var innerTerm = ((dataMatrixBBC.SSB*dataMatrixBBC.SSB/dataMatrixBBC.V_B)+(dataMatrixBBC.SSE*dataMatrixBBC.SSE/dataMatrixBBC.V_E))/(2*a*b*c*(dataMatrixBBC.SSB+dataMatrixBBC.SSE));
//dataMatrixBBC.LOAM_CI = 1.96*1.96*Math.sqrt(innerTerm);
var ICC = 0;
var ICC_CI = 0;

if (c > 0) {
    ICC       = dataMatrixBBC.SIGMA_A_2/(dataMatrixBBC.SIGMA_A_2+dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2);
    
    
    A = b * ICC / (a * (1 - ICC));
    B = 1 + b * ICC * (a - 1) / (a * (1 - ICC));
    
    
    v = (A * dataMatrixBBC.MSB + B * dataMatrixBBC.MSE)^2 / ((A * dataMatrixBBC.MSB)^2 / dataMatrixBBC.V_B + (B * dataMatrixBBC.MSE)^2 / dataMatrixBBC.V_E);
    
    
    FL = qf(0.975,a - 1, v,10e6);
    FU = qf(0.975, v, a - 1,10e6);
    
    
    low_num = a * (dataMatrixBBC.MSA - (FL * dataMatrixBBC.MSE));
    low_denom = FL * (b * dataMatrixBBC.MSB + (a * b - a - b) * dataMatrixBBC.MSE) + a * dataMatrixBBC.MSA;
    
    upp_num = a * (FU * dataMatrixBBC.MSA - dataMatrixBBC.MSE);
    upp_denom = b * dataMatrixBBC.MSB + (a * b - a - b) * dataMatrixBBC.MSE + a * FU * dataMatrixBBC.MSA;
    
    
    ICC_CI = [low_num / low_denom, upp_num / upp_denom];
    dataMatrixBBC.ICC_CI = ICC_CI;
    
    
} else {
    ICC       = 0;
    ICC_CI    = 0;
}





sortBy();




///////////////////////



plot = new Object();

plot.imageResize = new Image(); // Using optional size for image
plot.imageResize.src = 'img/zoom.png';
plot.imageMove = new Image(); // Using optional size for image
plot.imageMove.src = 'img/move.png';


plot.clickOffset = null;

plot.moveFig = false;
plot.resizeFig = false;


plot.selectedObserver = null;



plot.X_axisWidth = 300;
plot.X_axisLength = plot.X_axisWidth+100;


plot.Y_axisWidth = 200;
plot.Y_axisLength = plot.Y_axisWidth+100;


plot.origo = [50,230+plot.Y_axisLength];


plot.X_axisSpacing = 50;

plot.X_axis_Title = "Difference from the mean"+" (mm, "+getParameterByName("title").charAt(0).toLowerCase()+getParameterByName("title").slice(1)+")";
if (getParameterByName("yAxisTitle") != null)
    plot.X_axis_Title = getParameterByName("yAxisTitle"); 

plot.Y_axis_Title = "Subject-specific mean"+" (mm, "+getParameterByName("title").charAt(0).toLowerCase()+getParameterByName("title").slice(1)+")";
if (getParameterByName("xAxisTitle") != null)
    plot.Y_axis_Title = getParameterByName("xAxisTitle"); 


if (getParameterByName("participant") != null)
    participant = getParameterByName("participant"); 



setupPlotParameters();




message = "";
mousePos = null;


preprocessed = true;


updatePlot();

updateObserverTableInfo();

} // end preprocessing


function setupPlotParameters() {
    
    plot.rangeX = Math.ceil(dataMatrixBBC.meanYMax)-Math.floor(dataMatrixBBC.meanYMin);
    plot.pixelX = plot.rangeX;
    plot.rangeX = plot.X_axisWidth/plot.rangeX; //plot.rangeX px/unit

    plot.maxRangeY = Math.max(Math.ceil(dataMatrixBBC.d_ijMax), Math.abs(Math.floor(dataMatrixBBC.d_ijMin)));
    plot.maxRangeY = (plot.Y_axisWidth/2)/plot.maxRangeY // one unit = no px;

}



var countOutliers = 0;
// begin updatePlot

var alreadyAdded = new Array();

function updatePlot() {
   
countOutliers = 0;    
tableDeleteRows();


dataMatrixBBC.diffDistributionSelectedObserver = new Array(50).fill(0);

ctx.clearRect(0, 0, can.width, can.height);

//plot.selectedObserver = null;
document.body.style.cursor = "auto";




/// labels x- and y-axes
ctx.textAlign = "center";
    
ctx.fillText( plot.Y_axis_Title, plot.origo[0]+plot.X_axisLength/2,plot.origo[1]+40);

ctx.save();
    ctx.textAlign = "center";
    ctx.translate( plot.origo[0]-40, plot.origo[1]-plot.Y_axisLength/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText( plot.X_axis_Title, 0, 0 );
    
ctx.restore();    









// X- and Y-axis
ctx.beginPath();
ctx.moveTo(plot.origo[0], plot.origo[1]);
ctx.lineTo(plot.origo[0]+plot.X_axisLength, plot.origo[1]);
ctx.moveTo(plot.origo[0], plot.origo[1]+1);
ctx.lineTo(plot.origo[0], plot.origo[1]-plot.Y_axisLength);
ctx.stroke();



    
// line of zero difference    
ctx.beginPath();
ctx.moveTo(plot.origo[0], plot.origo[1]-plot.Y_axisLength/2);
ctx.lineTo(plot.origo[0]+plot.X_axisLength, plot.origo[1]-plot.Y_axisLength/2);
ctx.stroke();



// lower limit    
ctx.beginPath();
ctx.moveTo(plot.origo[0], (plot.origo[1]-plot.Y_axisLength/2)+dataMatrixBBC.LOAM*plot.maxRangeY);
ctx.lineTo(plot.origo[0]+plot.X_axisLength, (plot.origo[1]-plot.Y_axisLength/2)+dataMatrixBBC.LOAM*plot.maxRangeY);
ctx.stroke();




// CI lower

if (b>2) {
ctx.setLineDash([3, 1]);
ctx.beginPath();
ctx.moveTo(plot.origo[0], (plot.origo[1]-plot.Y_axisLength/2)+(dataMatrixBBC.LOAM_CI2[1])*plot.maxRangeY);
ctx.lineTo(plot.origo[0]+plot.X_axisLength, (plot.origo[1]-plot.Y_axisLength/2)+(dataMatrixBBC.LOAM_CI2[1])*plot.maxRangeY);
ctx.stroke();
ctx.beginPath();
ctx.moveTo(plot.origo[0], (plot.origo[1]-plot.Y_axisLength/2)+(dataMatrixBBC.LOAM_CI2[0])*plot.maxRangeY);
ctx.lineTo(plot.origo[0]+plot.X_axisLength, (plot.origo[1]-plot.Y_axisLength/2)+(dataMatrixBBC.LOAM_CI2[0])*plot.maxRangeY);
ctx.stroke();
ctx.setLineDash([]);
}



// upper limit
ctx.beginPath();
ctx.moveTo(plot.origo[0], (plot.origo[1]-plot.Y_axisLength/2)-dataMatrixBBC.LOAM*plot.maxRangeY);
ctx.lineTo(plot.origo[0]+plot.X_axisLength, (plot.origo[1]-plot.Y_axisLength/2)-dataMatrixBBC.LOAM*plot.maxRangeY);
ctx.stroke();



// CI upper
if (b>2) {
ctx.setLineDash([3, 1]);

ctx.beginPath();
ctx.moveTo(plot.origo[0], (plot.origo[1]-plot.Y_axisLength/2)-(dataMatrixBBC.LOAM_CI2[1])*plot.maxRangeY);
ctx.lineTo(plot.origo[0]+plot.X_axisLength, (plot.origo[1]-plot.Y_axisLength/2)-(dataMatrixBBC.LOAM_CI2[1])*plot.maxRangeY);
ctx.stroke();


ctx.beginPath();
ctx.moveTo(plot.origo[0], (plot.origo[1]-plot.Y_axisLength/2)-(dataMatrixBBC.LOAM_CI2[0])*plot.maxRangeY);
ctx.lineTo(plot.origo[0]+plot.X_axisLength, (plot.origo[1]-plot.Y_axisLength/2)-(dataMatrixBBC.LOAM_CI2[0])*plot.maxRangeY);
ctx.stroke();

ctx.setLineDash([]);
}




ctx.textAlign = "right";
ctx.textBaseline = "middle";

// write LOAM
ctx.fillText((Math.round(dataMatrixBBC.LOAM * 10) / 10).toFixed(1), plot.origo[0]-5, (plot.origo[1]-plot.Y_axisLength/2)-dataMatrixBBC.LOAM*plot.maxRangeY);
ctx.fillText("-"+(Math.round(dataMatrixBBC.LOAM * 10) / 10).toFixed(1), plot.origo[0]-5, (plot.origo[1]-plot.Y_axisLength/2)+dataMatrixBBC.LOAM*plot.maxRangeY);
ctx.fillText(0, plot.origo[0]-5, (plot.origo[1]-plot.Y_axisLength/2)); // number for line of zero difference


ctx.textAlign = "left";



// draw dots
var onoverDots = new Array();
alreadyAdded = new Array();
var entriesAdded = 0;


tempHTML = "";
tempHTMLArray = new Array();
sortedHighlight = new Array();
var indexValue = document.getElementById("sortByDropdownHighlighted").value;
for(j=0;j<a;j++) {
    
    
    
    for(i=0;i<b;i++) 
    {
    var alreadyVisited = false;    
    for(k=0;k<c;k++) {    
        
        // new BBC
        var dotX = plot.origo[0]+plot.X_axisSpacing+(dataMatrixBBC.meanYi[j]-Math.floor(dataMatrixBBC.meanYMin))*plot.rangeX;
        var dotY = (plot.origo[1]-plot.Y_axisLength/2)-dataMatrixBBC[i][j][1][k]*plot.maxRangeY;
        
        
        drawDot(dotX, dotY, 3, "black", i);
        
        /*
        if (Math.abs(Math.round(dataMatrixBBC[i][j][1][k] * 100) / 100) > 2.33) {
             
        }
        */
        
        if (plot.selectedObserver == i) {
                    
                    
                    var diffRatio = ((dataMatrixBBC[i][j][1][k]-dataMatrixBBC.d_ijMin)/dataMatrixBBC.rangeDiff)*50;
                    dataMatrixBBC.diffDistributionSelectedObserver[Math.floor(diffRatio)]++;
                    
        }
        
        if (alreadyVisited) {
             ctx.restore();
            continue;
        }
        
        
        
        if (mousePos != null) {
            
            var outlierHighlight = false;
            
            //if ((Math.abs(Math.round(dataMatrixBBC[i][j][1][k] * 100) / 100) >= 3)) {
            
            if (Math.abs(dataMatrixBBC[i][j][1][k]) > dataMatrixBBC.outlierLimit) {
            
            //if (Math.abs((dataMatrixBBC[i][j][1][0]) - (dataMatrixBBC[i][j][1][1])) > 2.33) {
                
                outlierHighlight = true;
                //countOutliers++;
                
            }
            //outlierHighlight = false;
            
            if (outlierHighlight || subjectList[j] == 1 || ((mousePos.x < dotX+5 && mousePos.x > dotX-5 && mousePos.y < dotY+5 && mousePos.y > dotY-5) && clickSelectedObserver == null) || (plot.selectedObserver == i && clickSelectedObserver == null) || clickSelectedObserver == i) {
                
                alreadyVisited = true;
                
                
                //if (clickSelectedObserver == i || plot.selectedObserver == i || subjectList[j] == 1) {
                        
                        
                    
                
                  
                
                    for(v=0;v<c;v++) {
                        var  num = parseInt(String(j)+String(i)+String(v));
                        if (alreadyAdded.includes(num)) {
                            
                        }
                        else {
                            alreadyAdded.push( num );    
                        }
                        
                        
                        if (Math.abs(dataMatrixBBC[i][j][1][v]) > dataMatrixBBC.outlierLimit) {
                             
                             countOutliers++;
                        }            
                        
                       // if (outlierHighlight && (Math.abs(Math.round(dataMatrixBBC[i][j][1][v] * 100) / 100) <= 3)) {
                        if (outlierHighlight && ((Math.abs((dataMatrixBBC[i][j][1][v] * 100) / 100) <= dataMatrixBBC.outlierLimit)) ) { // OBSSSS
                            
                            //countOutliers++;
                            // add the repeated mesurements or...
                            continue;
                        }
                        
                    
                    entry = v;
                    //entry = k;
                    
                    entriesAdded++;
                    
                    ctx.save();
                    if (entry > 0)
                        ctx.strokeStyle = "#FF0000";
                       
                    ctx.beginPath();
                    dotY = (plot.origo[1]-plot.Y_axisLength/2)-dataMatrixBBC[i][j][1][entry]*plot.maxRangeY;
                    ctx.arc(dotX, dotY, 5, 0, 2 * Math.PI);
                    ctx.stroke();
                    ctx.restore();
                    
                    //var pushString = entriesAdded+": "+dataMatrixBBC[i][j][2]+"; Measurement (" + entry + "): "+(Math.round(dataMatrixBBC[i][j][0][entry] * 100) / 100).toFixed(2)+";";
                    var pushString = dataMatrixBBC[i][j][2]+"; Measurement (k=" + entry + "): "+(Math.round(dataMatrixBBC[i][j][0][entry] * 100) / 100).toFixed(2)+";";
                    
                    
                    pushString += " Diff mean (i="+j+") ("+dataKiTSID.data[j]+") (="+(Math.round(dataMatrixBBC.meanYi[j] * 100) / 100).toFixed(2)+"): <b>"+(Math.round(dataMatrixBBC[i][j][1][entry] * 100) / 100).toFixed(2) + "</b>";
                    
                   
                    
                   
                    
                    
                    //onoverDots.push(pushString);
                
                    
                   if (data2 != null && true) {
                
                        pushString = ""+pushString;
                        //pushString += " Angle: "+(Math.round(dataMatrixBBC[i][j][3][entry] * 100) / 100).toFixed(2) + " Z-pos: "+ (Math.round(dataMatrixBBC[i][j][5][entry] * 100) / 100).toFixed(2);
                       // pushString += "<a href='javascript:flag("+j+","+i+","+v+")'> (Flag)" + "</a>";
                        
                      //  pushString += "<a href='javascript:getScreenshot("+j+","+i+","+v+")'> (Screenshot)" + "</a>";
                        pushString += "<a href='javascript:getScreenshot2("+j+","+i+","+v+")'> (Screenshot)" + "</a>";
                      
                        //pushString += "<a href='javascript:getScreenshots("+j+","+i+","+v+")'> (Screenshots)" + "</a>";
                        
                   }
                   
                   
                   
                     
                    //myTableUpdater(pushString);
                    tempHTML += pushString + "<br>";
                    tempHTMLArray.push(pushString);
                    
                    
                    
                    
                    if (indexValue == "subject")
                        sortedHighlight.push([entriesAdded-1,entriesAdded-1]);
                    else if (indexValue == "diffMean")
                        sortedHighlight.push([entriesAdded-1,dataMatrixBBC[i][j][1][entry]]);
                    else if (indexValue == "observer")
                        sortedHighlight.push([entriesAdded-1,i]);
                    else if (indexValue == "measurement")
                        sortedHighlight.push([entriesAdded-1,dataMatrixBBC[i][j][0][entry]]);
                    else if (indexValue == "angle")
                        sortedHighlight.push([entriesAdded-1,dataMatrixBBC[i][j][3][entry]]);
                    
                    }
                
            }    
        }
    
    } // end k    
    } // end i
    
    
}   // end j

//basse
sortedHighlight.sort((a,b) => a[1] - b[1]);
tempHTML = "";
for(h=0;h<sortedHighlight.length;h++) {
    
    var tempString = (h+1)+": "+tempHTMLArray[sortedHighlight[h][0]];
                   if (((h+1) % 2) == 0) {
                       
                       tempString = "<span style='background-color: lightgrey'>"+tempString + "</span>";
                        
                       
                   }
                    
  
    
    tempHTML += tempString + "<br>";
    
    
}


table.innerHTML = tempHTML;


for(d=0;d<onoverDots.length;d++) {
    
    ctx.fillText(onoverDots[d], plot.tableX+20, plot.tableY+190+d*10);
    
}

// startNotch
ctx.beginPath();
ctx.moveTo(plot.origo[0]+plot.X_axisSpacing, plot.origo[1]-3);
ctx.lineTo(plot.origo[0]+plot.X_axisSpacing, plot.origo[1]+3);
ctx.stroke();




// start/end notch number
ctx.textAlign = "center";
ctx.fillText(Math.floor(dataMatrixBBC.meanYMin), plot.origo[0]+plot.X_axisSpacing, plot.origo[1]+15);



var xIntRange = plot.pixelX;

var ratioPxNotch = plot.X_axisWidth/xIntRange;


plot.X_axisSpacingMod = 1; // (Math.floor(xIntRange/(plot.X_axisWidth/50)));

if (ratioPxNotch < 10) {
    plot.X_axisSpacingMod = 1 + Math.round(10/ratioPxNotch);
}

// tacks x-axis
for (x=0;x<xIntRange;x++) {
    
    if (x == 0)
        continue;
    if (x % plot.X_axisSpacingMod != 0)
        continue;
    
    ctx.beginPath();
    ctx.moveTo(plot.origo[0]+plot.X_axisSpacing+plot.X_axisWidth*(x/xIntRange), plot.origo[1]-3);
    ctx.lineTo(plot.origo[0]+plot.X_axisSpacing+plot.X_axisWidth*(x/xIntRange), plot.origo[1]+3);
    ctx.stroke();
    ctx.fillText(Math.floor(dataMatrixBBC.meanYMin)+x, plot.origo[0]+plot.X_axisSpacing+plot.X_axisWidth*(x/xIntRange), plot.origo[1]+15);

    
}




// plot.Y_axisWidth

// upper notch y-axis, begin at middle of y-axis = zero line
ctx.beginPath(); // 
ctx.moveTo(plot.origo[0]-3, (plot.origo[1]-plot.Y_axisLength/2)-(plot.Y_axisWidth/2));
ctx.lineTo(plot.origo[0]+3, (plot.origo[1]-plot.Y_axisLength/2)-(plot.Y_axisWidth/2));
ctx.stroke();

// lower notch y-axis
ctx.beginPath();
ctx.moveTo(plot.origo[0]-3, (plot.origo[1]-plot.Y_axisLength/2)+(plot.Y_axisWidth/2));
ctx.lineTo(plot.origo[0]+3, (plot.origo[1]-plot.Y_axisLength/2)+(plot.Y_axisWidth/2));
ctx.stroke();

ctx.textAlign = "right";
ctx.textBaseline = "middle";

ctx.fillText(Math.ceil((plot.Y_axisWidth/2)/plot.maxRangeY), plot.origo[0]-5, (plot.origo[1]-plot.Y_axisLength/2)-(plot.Y_axisWidth/2));
ctx.fillText(Math.floor(-((plot.Y_axisWidth/2)/plot.maxRangeY)), plot.origo[0]-5, (plot.origo[1]-plot.Y_axisLength/2)+(plot.Y_axisWidth/2));

ctx.textAlign = "left";


    
      
  
 
plot.tableX = 50;
plot.tableY = 20;



//// LOAM info
var LOAMinfoTable = document.getElementById("tableText6");
var tempLOAMinfoTable = "";
LOAMinfoTable.innerHTML = "";


//ctx.beginPath();
//ctx.rect(45, 5, 250, 210);
//ctx.stroke();

//ctx.fillText("b (observers): "+b, plot.tableX, plot.tableY+0);
tempLOAMinfoTable += "<span>b (observers): "+b+"</span><br>";

//ctx.fillText("a (subjects): "+a, plot.tableX, plot.tableY+10);
tempLOAMinfoTable += "<span>a (subjects): "+a+"</span><br>";

//ctx.fillText("c (# measurements/subject): "+c, plot.tableX, plot.tableY+20);
tempLOAMinfoTable += "<span>c (# measurements/subject): "+c+"</span><br>";


//ctx.fillText(""+message, plot.tableX, plot.tableY+180);


//ctx.fillText("95% limits of agreement mean: +/-"+(Math.round((dataMatrixBBC.LOAM) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.LOAM_CI2[0]) * 100) / 100).toFixed(2)+","+(Math.round((dataMatrixBBC.LOAM_CI2[1]) * 100) / 100).toFixed(2)+")", plot.tableX, plot.tableY+30);
tempLOAMinfoTable += "<span>"
tempLOAMinfoTable += "95% limits of agreement mean: +/-"+(Math.round((dataMatrixBBC.LOAM) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.LOAM_CI2[0]) * 100) / 100).toFixed(2)+" to "+(Math.round((dataMatrixBBC.LOAM_CI2[1]) * 100) / 100).toFixed(2)+")</span>"+"<br>";

//ctx.fillText("Width 95% CI limits of agreement mean: "+(Math.round((dataMatrixBBC.LOAM_CI2[1]-dataMatrixBBC.LOAM_CI2[0]) * 100) / 100).toFixed(2), plot.tableX, plot.tableY+40);
tempLOAMinfoTable += "Width 95% CI limits of agreement mean: "+(Math.round((dataMatrixBBC.LOAM_CI2[1]-dataMatrixBBC.LOAM_CI2[0]) * 100) / 100).toFixed(2)+"<br>";


//ctx.fillText("Grand maximum measurement: "+(Math.round(dataMatrixBBC.grandMax * 100) / 100).toFixed(2), plot.tableX, plot.tableY+50);
tempLOAMinfoTable += "Grand maximum measurement: "+(Math.round(dataMatrixBBC.grandMax * 100) / 100).toFixed(2)+"<br>";

//ctx.fillText("Grand minimum measurement: "+(Math.round(dataMatrixBBC.grandMin * 100) / 100).toFixed(2), plot.tableX, plot.tableY+60);
tempLOAMinfoTable += "Grand minimum measurement: "+(Math.round(dataMatrixBBC.grandMin * 100) / 100).toFixed(2)+"<br>";


//ctx.fillText("Subject (max mean): "+(Math.round(dataMatrixBBC.meanYMax * 100) / 100).toFixed(2), plot.tableX, plot.tableY+70);
tempLOAMinfoTable += "Subject (max mean): "+(Math.round(dataMatrixBBC.meanYMax * 100) / 100).toFixed(2)+"<br>";

//ctx.fillText("Subject (min mean): "+(Math.round(dataMatrixBBC.meanYMin * 100) / 100).toFixed(2), plot.tableX, plot.tableY+80);
tempLOAMinfoTable += "Subject (min mean): "+(Math.round(dataMatrixBBC.meanYMin * 100) / 100).toFixed(2)+"<br>";




//ctx.fillText("d_ij (max): "+(Math.round(dataMatrixBBC.d_ijMax * 100) / 100).toFixed(2), plot.tableX, plot.tableY+90);
tempLOAMinfoTable += "d<sub>ij</sub> (max): "+(Math.round(dataMatrixBBC.d_ijMax * 100) / 100).toFixed(2)+"<br>";

//ctx.fillText("d_ij (min): "+(Math.round(dataMatrixBBC.d_ijMin * 100) / 100).toFixed(2), plot.tableX, plot.tableY+100);
tempLOAMinfoTable += "d<sub>ij</sub> (min): "+(Math.round(dataMatrixBBC.d_ijMin * 100) / 100).toFixed(2)+"<br>";


//ctx.fillText("SD_A: "+(Math.round((dataMatrixBBC.SIGMA_A) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.SIGMA_A_CI[0]) * 100) / 100).toFixed(2)+","+(Math.round((dataMatrixBBC.SIGMA_A_CI[1]) * 100) / 100).toFixed(2)+")", plot.tableX, plot.tableY+110);
tempLOAMinfoTable += "&#963;<sub>A</sub>: "+(Math.round((dataMatrixBBC.SIGMA_A) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.SIGMA_A_CI[0]) * 100) / 100).toFixed(2)+" to "+(Math.round((dataMatrixBBC.SIGMA_A_CI[1]) * 100) / 100).toFixed(2)+")"+"<br>";

if (dataMatrixBBC.SIGMA_B_2 < 0) {
    //ctx.fillText("SD_B: < 0", plot.tableX, plot.tableY+120);
    tempLOAMinfoTable += "&#963;<sub>B</sub>: < 0"+"<br>";

}
else {
    //ctx.fillText("SD_B: "+(Math.round((dataMatrixBBC.SIGMA_B) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.SIGMA_B-dataMatrixBBC.SIGMA_B_CI) * 100) / 100).toFixed(2)+","+(Math.round((dataMatrixBBC.SIGMA_B+dataMatrixBBC.SIGMA_B_CI) * 100) / 100).toFixed(2)+")", plot.tableX, plot.tableY+120);
    tempLOAMinfoTable += "&#963;<sub>B</sub>:: "+(Math.round((dataMatrixBBC.SIGMA_B) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.SIGMA_B-dataMatrixBBC.SIGMA_B_CI) * 100) / 100).toFixed(2)+" to "+(Math.round((dataMatrixBBC.SIGMA_B+dataMatrixBBC.SIGMA_B_CI) * 100) / 100).toFixed(2)+")"+"<br>";
}

//ctx.fillText("SD_E: "+(Math.round((dataMatrixBBC.SIGMA_E) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.SIGMA_E_CI2[0]) * 100) / 100).toFixed(2)+","+(Math.round((dataMatrixBBC.SIGMA_E_CI2[1]) * 100) / 100).toFixed(2)+")", plot.tableX, plot.tableY+130);
tempLOAMinfoTable += "&#963;<sub>E</sub>:: "+(Math.round((dataMatrixBBC.SIGMA_E) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.SIGMA_E_CI2[0]) * 100) / 100).toFixed(2)+" to "+(Math.round((dataMatrixBBC.SIGMA_E_CI2[1]) * 100) / 100).toFixed(2)+")"+"<br>";

//ctx.fillText("ICC: "+(Math.round((dataMatrixBBC.ICC) * 100) / 100).toFixed(2), plot.tableX, plot.tableY+140);
tempLOAMinfoTable += "ICC: "+(Math.round((dataMatrixBBC.ICC) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.ICC_CI[0]) * 100) / 100).toFixed(2)+" to "+(Math.round((dataMatrixBBC.ICC_CI[1]) * 100) / 100).toFixed(2)+")"+"<br>";


//ctx.fillText("Grand mean: "+(Math.round((dataMatrixBBC.grandMean) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.grandMean-grandMeanCI()) * 100) / 100).toFixed(2)+","+(Math.round((dataMatrixBBC.grandMean+grandMeanCI()) * 100) / 100).toFixed(2)+")", plot.tableX, plot.tableY+160);
tempLOAMinfoTable += "Grand mean: "+(Math.round((dataMatrixBBC.grandMean) * 100) / 100).toFixed(2)+" ("+(Math.round((dataMatrixBBC.grandMean-grandMeanCI()) * 100) / 100).toFixed(2)+" to "+(Math.round((dataMatrixBBC.grandMean+grandMeanCI()) * 100) / 100).toFixed(2)+")"+"<br>";


/// LOAM info


//ctx.textAlign = "left";
//ctx.fillText("Agreement plot.", 0, can.height-50);
//ctx.fillText("Horizontal axis represent average. Vertical axis represent difference from the mean. Individual measurements of observers represented by black dots. Note some dots have been superimposed.", 0, can.height-40);
//ctx.fillText("Horizontal lines indicate upper and lower limits of agreement with the mean and a line of zero difference. Dashed lines correspond to the confidence intervals for the limits of agreement.", 0, can.height-30);


LOAMinfoTable.innerHTML = tempLOAMinfoTable; 



// begin histogram
histogram.xAxisLength = 100;
histogram.yAxisLength = 100;


histogram.x = plot.origo[0]+plot.X_axisLength+40;
histogram.y = plot.origo[1]-(plot.Y_axisLength/2)+(histogram.yAxisLength/2);


ctx.textAlign = "center";

// histogram
// X-axis
ctx.beginPath();
ctx.moveTo(histogram.x, histogram.y);
ctx.lineTo(histogram.x+histogram.xAxisLength, histogram.y);
ctx.stroke();
// Y-axis
ctx.beginPath();
ctx.moveTo(histogram.x, histogram.y);
ctx.lineTo(histogram.x, histogram.y-histogram.yAxisLength);
ctx.stroke();


// Begin notch
ctx.beginPath();
ctx.moveTo(histogram.x+10, histogram.y);
ctx.lineTo(histogram.x+10, histogram.y+5);
ctx.stroke();
ctx.fillText((Math.round(dataMatrixBBC.d_ijMin * 100) / 100).toFixed(2), histogram.x+10, histogram.y+15);


// End notch
ctx.beginPath();
ctx.moveTo(histogram.x+60, histogram.y);
ctx.lineTo(histogram.x+60, histogram.y+5);
ctx.stroke();
ctx.fillText((Math.round(dataMatrixBBC.d_ijMax * 100) / 100).toFixed(2), histogram.x+60, histogram.y+15);


histogram.max = Math.max(...dataMatrixBBC.diffDistribution2);
histogram.maxPercentage = histogram.max/(a*b*c); 
histogram.maxIndex = dataMatrixBBC.diffDistribution2.indexOf(Math.max(...dataMatrixBBC.diffDistribution2));


ctx.beginPath();
ctx.moveTo(histogram.x+10+(histogram.maxIndex), histogram.y);
ctx.lineTo(histogram.x+10+(histogram.maxIndex), histogram.y+10);
ctx.stroke();

histogram.maxNotchNumber = dataMatrixBBC.d_ijMin+(histogram.maxIndex/50)*dataMatrixBBC.rangeDiff;
histogram.maxNotchNumber = (Math.round(histogram.maxNotchNumber * 100) / 100).toFixed(2);

ctx.fillText(histogram.maxNotchNumber, histogram.x+10+(histogram.maxIndex), histogram.y+25);

ctx.textAlign = "left";


// max notch y-axis
ctx.beginPath();
ctx.moveTo(histogram.x,  histogram.y-(histogram.yAxisLength-1));
ctx.lineTo(histogram.x-5,  histogram.y-(histogram.yAxisLength-1));
ctx.stroke();


ctx.textAlign = "right";
ctx.textBaseline = "middle";

ctx.fillText((Math.round(histogram.maxPercentage*100 * 100) / 100).toFixed(2)+"%", histogram.x-7, histogram.y-(histogram.yAxisLength-1));




    for(h=0;h<50;h++) {
        
        var ratio = dataMatrixBBC.diffDistribution2[h]/(a*b*c);
        
        var newRatio = ratio/histogram.maxPercentage;
        
        ctx.beginPath();
        ctx.moveTo(histogram.x+10+h, histogram.y);
       
        ctx.lineTo(histogram.x+10+h, histogram.y-(newRatio*histogram.yAxisLength));
       
        ctx.stroke();
        
        
        if (dataMatrixBBC.diffDistributionSelectedObserver[h] > 0) {
            
            var ratio = dataMatrixBBC.diffDistributionSelectedObserver[h]/(a*b*c);
        
        
            var newRatio = ratio/histogram.maxPercentage;
            var move = (newRatio*histogram.yAxisLength)
            
            ctx.strokeStyle = "#FF0000";
            ctx.beginPath();
            ctx.moveTo(histogram.x+10+h, histogram.y+1);
       
            ctx.lineTo(histogram.x+10+h, histogram.y-move);
       
            ctx.stroke();
        
        
        }
        
        
        ctx.strokeStyle = "#000000";
        
        
    
    } // end histogram




//(plot.origo[0]+plot.X_axisLength

ctx.drawImage(plot.imageResize, plot.origo[0]+plot.X_axisLength, plot.origo[1]);
ctx.drawImage(plot.imageMove, plot.origo[0]-16, plot.origo[1]);


//ctx.drawImage(plot.imageResize, plot.origo[0], plot.origo[1]);

//ctx.drawImage(plot.imageResize, 0, plot.origo[1]);



} // end updatePlot()


var lockedScreen = false;


can.addEventListener('mousemove', function(evt) {
       // console.log(plot.moveFig+"lol");
        mousePos = getMousePos(can, evt);
        
        
        if (moveGUI)
            return;
        
        
        //ctx.drawImage(plot.imageResize, plot.origo[0]+plot.X_axisLength, plot.origo[1]);
        //ctx.drawImage(plot.imageMove, plot.origo[0]-16, plot.origo[1]);
        if (mousePos.x > (plot.origo[0]-16) && mousePos.x < (plot.origo[0]) && mousePos.y > (plot.origo[1]) && mousePos.y < (plot.origo[1]+16))
            can.style.cursor = "move";
        else if (mousePos.x > (plot.origo[0]+plot.X_axisLength) && mousePos.x < (plot.origo[0]+plot.X_axisLength+16) && mousePos.y > (plot.origo[1]) && mousePos.y < (plot.origo[1]+16))
            can.style.cursor = "nw-resize";
        else
            can.style.cursor = "pointer";
        
        if (plot.moveFig) {
            
            plot.origo = [mousePos.x+plot.clickOffset[0],mousePos.y-plot.clickOffset[0]];
        
            
            
            updatePlot();
            return;
        }
        if (plot.resizeFig) {
            if ((mousePos.x-plot.origo[0]) < 150)
                return;
            plot.X_axisLength = mousePos.x-(plot.origo[0]+plot.clickOffset[0]);
            
            
            plot.X_axisWidth = plot.X_axisLength-100; 
        
            
            currentYaxisEdge = plot.origo[1]-(plot.Y_axisLength);
            
            if ((mousePos.y-plot.clickOffset[1])-currentYaxisEdge < 150)
                return;
            plot.Y_axisLength = (mousePos.y-plot.clickOffset[1])-currentYaxisEdge;
            
            
            plot.Y_axisWidth = plot.Y_axisLength-100; 
            
            plot.origo[1] = mousePos.y-plot.clickOffset[1];
            
            
            //plot.Y_axisWidth = 200;
            //plot.Y_axisLength = plot.Y_axisWidth+100;

        
        
            setupPlotParameters();
            
            updatePlot();
            return;
        }
        if (lockedScreen )
            return;
        
       
    
        if (preprocessed) {
        
        
        var X_axis = (Math.floor(dataMatrixBBC.meanYMin)+(mousePos.x-(plot.origo[0]+50))/plot.rangeX);
        X_axis = (Math.round((X_axis) * 100) / 100).toFixed(2)
        
        var Y_axis = -(mousePos.y-(  plot.origo[1]-plot.Y_axisLength/2  )) / plot.maxRangeY;
        Y_axis = (Math.round((Y_axis) * 100) / 100).toFixed(2)
        
        
        message = 'Mouse position: ' + Math.round(mousePos.x) + ' , ' + Math.round(mousePos.y)+" X-axis: "+X_axis+" Y-axis: "+Y_axis;
        
        if (plot.selectedObserver > -1)
            updatePlotSelectedObserverOut(event);
        else
            updatePlot();
        }
      
}, false);



var clickSelectedObserver = null;
can.addEventListener('mousedown', function(evt) {
    
   mousePos = getMousePos(can, evt);
   
   //console.log(mousePos);
   if (mousePos.x < plot.origo[0]+16 && mousePos.x > plot.origo[0]-16 && mousePos.y < plot.origo[1]+16 && mousePos.y > plot.origo[1]-16) {
        plot.moveFig = true;
        plot.clickOffset = [plot.origo[0]-mousePos.x,mousePos.y-plot.origo[1]];
        return;

   }
   if (mousePos.x < (plot.origo[0]+plot.X_axisLength+20) && mousePos.x > (plot.origo[0]+plot.X_axisLength) && mousePos.y < plot.origo[1]+20 && mousePos.y > plot.origo[1]) {
   
    plot.resizeFig = true;
    plot.clickOffset = [mousePos.x-(plot.X_axisLength+plot.origo[0]),mousePos.y-plot.origo[1]];
        
    return;
   }
   
   
   
   

if (clickSelectedObserver != null) {
    clickSelectedObserver = null;
    lockedScreen = false;
 }    
 else {
    lockedScreen = !lockedScreen;
 }
 
 updatePlot();
      
}, false);

can.addEventListener('mouseup', function(evt) {
    plot.moveFig = false;
    plot.resizeFig = false;
}, false);






function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
}


var dotColors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080', '#ffffff', '#000000'];
function drawDot(x,y, width, color, observer) {
    
  
    ctx.save();
    
    ctx.fillStyle = dotColors[observer];
    
    ctx.fillRect(x-(width/2),y-(width/2),width,width);
    
    ctx.restore();
  
    
}   


function estimateWidth() {
    
    // baseret p estimat fra b=5 a=40
    console.log("SigmaB^2,0: "+dataMatrixBBC.SIGMA_B_2);
    console.log("SigmaE^2,0: "+dataMatrixBBC.SIGMA_E_2);
    
    
    console.log(".");
     console.log("..");
     
    // krer igennem for b(s) = 3 -> 7
    for (s=3;s<26;s++) {
        //console.log(">>>>>>>>>>>>>>>>>>>> s = "+s)
    
        var V_B_temp = s - 1;
       // console.log("V_B: "+V_B_temp);
        
        var V_E_temp = a*s*c-a-s+1;
       // console.log("V_E: "+V_E_temp);
        
        var l_B_temp = 1-(1/qf(0.975,V_B_temp,10e6,10e6));
       // console.log("lb: s="+s+": "+l_B_temp);
        
        var l_E_temp = 1-(1/qf(0.975,V_E_temp,10e6,10e6));
      //  console.log("le: s="+s+": "+l_E_temp);
        
        var h_B_temp = (1/qf(0.025,V_B_temp,10e6,10e6))-1;
      //  console.log("hb: s="+s+": "+h_B_temp);
        
        var h_E_temp = (1/qf(0.025,V_E_temp,10e6,10e6))-1;
      //  console.log("he: s="+s+": "+h_E_temp);
        
        var L_0 = l_B_temp*l_B_temp*V_B_temp*V_B_temp*Math.pow(a*c*dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2,2)+l_E_temp*l_E_temp*V_E_temp*V_E_temp*Math.pow(dataMatrixBBC.SIGMA_E_2,2);
        L_0 = Math.sqrt(L_0); 
        
        var H_0 = h_B_temp*h_B_temp*V_B_temp*V_B_temp*Math.pow(a*c*dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2,2)+h_E_temp*h_E_temp*V_E_temp*V_E_temp*Math.pow(dataMatrixBBC.SIGMA_E_2,2);
        H_0 = Math.sqrt(H_0); 
        
        var W_inner_1 = V_B_temp*(a*c*dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2)+V_E_temp*dataMatrixBBC.SIGMA_E_2+H_0;
        
        var W_inner_2 = V_B_temp*(a*c*dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2)+V_E_temp*dataMatrixBBC.SIGMA_E_2-L_0;
        
        var W = (1.96/Math.sqrt(a*s*c))*(Math.sqrt(W_inner_1)-Math.sqrt(W_inner_2));
        
        console.log("CI width(W) s(b) = "+s+": "+W);
    
    }
    
    
}


function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}



var data = null; 


var fileName = "";
if (getParameterByName("file") != null)
    fileName = getParameterByName("file")  + "?c="+Math.random();

//data = Papa.parse("jonesLungData.csv", {

var fileName2 = fileName.split('.')[0]+"ID."+fileName.split('.')[1] + "?c="+Math.random();
var data2 = null;
var fileName3 = fileName.split('.')[0]+"Coords."+fileName.split('.')[1] + "?c="+Math.random();
var data3 = null;

//fileName2 = "SRMn5_0ID.csv";


if (fileName != "") {
data = Papa.parse(fileName, {
	download: true,
	complete: function(results) {
		console.log(results);
		data = results;
		
		
		 if (getParameterByName("c") != null)
            c = parseInt(getParameterByName("c"));

		observerList = new Array(((data.data[0].length)/c));
        observerList.fill(1);
		
		subjectList = new Array(((data.data.length-1)/1));
        subjectList.fill(0);
		
		
		preprocessing();
		
		
		
		
	}
});


data2 = Papa.parse(fileName2, {
	download: true,
	complete: function(results) {
		console.log(results);
		//return;
		data2 = results;
		
		
		 
		
	}
});


/*
data3 = Papa.parse(fileName3, {
	download: true,
	complete: function(results) {
		console.log(results);
		return;
		data3 = results;
		//data3 = null;
		
		var x = document.getElementById("sortByDropdownHighlighted");
        var option = document.createElement("option");
        option.text = "Angle";
        option.value = "angle";
        x.add(option);
		preprocessing();
		
		 
		
	}

	
});
*/


dataNC = Papa.parse("SRM/SRMn6_1new.csv", {
	download: true,
	complete: function(results) {
		console.log(results);
		dataNC = results;
		
		
		 
		
	}
});



dataKiTSID = Papa.parse("SRM/KiTSID.csv", {
	download: true,
	complete: function(results) {
		console.log(results);
		dataKiTSID = results;
		
		
		 
		
	}
});


}





 function upload(evt) {
 

 var file = evt.target.files[0];
 console.log(file);
 var reader = new FileReader();
 reader.readAsText(file);
 reader.onload = function(event) {
 var csvData = event.target.result;
 
 data = Papa.parse(csvData, {header : false});
 
 console.log(data);
 
 
 preprocessing();
 
 };
 reader.onerror = function() {
 alert('Unable to read ' + file.fileName);
 };
 
}

function estimateHalfWidth() {
    
    var halfWidth = parseFloat(prompt("Please enter desired half-width", ""));
    var subjects = a;
    
    dataMatrixBBC.power = (Math.pow(1.96,4))/(2*subjects*Math.pow(halfWidth,2))*(((subjects-1)*Math.pow(dataMatrixBBC.SIGMA_B_2,2)+Math.pow(dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2,2))/(dataMatrixBBC.SIGMA_B_2+dataMatrixBBC.SIGMA_E_2));

    alert(dataMatrixBBC.power);    
}


    
document.getElementById('txtFileUpload').addEventListener('change', upload, false);


var sortedList;
function sortBy() {
   var indexValue = document.getElementById("sortByDropdown").value;
   
   sortedList = new Array();
   
   for(i=0;i<a;i++) {
       
       if (indexValue == "subject")
        sortedList.push([i,dataMatrixBBC.meanYi[i]]);
       if (indexValue == "mean")
        sortedList.push([i,dataMatrixBBC.meanYi[i]]);
       if (indexValue == "meanSD")
        sortedList.push([i,dataMatrixBBC.meanYiSD[i]]);
       if (indexValue == "meanMDist")
        sortedList.push([i,dataMatrixBBC.meanMidpointDist_i[i]]);
       if (indexValue == "meanADiff")
        sortedList.push([i,dataMatrixBBC.meanAngleDiff_i[i]]);
       
   }
   //dataMatrixBBC.meanYiSD[currentI]
   
   if (indexValue == "mean" || indexValue == "meanSD" || indexValue == "meanMDist" || indexValue == "meanADiff")
    sortedList.sort((a,b) => a[1] - b[1]);
   
  populateSubjectTable();

    
}

var sortedHighlight = new Array();
function sortByHighlighted() {
    //document.getElementById("sortByDropdownHighlighted").value;
    updatePlot();
}

var sortedObservers = new Array();
function sortByObservers() {
    updateObserverTableInfo();
}



var outlierRange = document.getElementById("outlierRange");
outlierRange.oninput = function() {
        
        dataMatrixBBC.outlierLimit = this.value;
        updatePlot();
        outputOutlierRange.innerHTML = "> "+this.value+" (" + countOutliers+"/"+ (c*a*b) + ")";
}

function setOutlierRange() {
    
    outlierRange.max = Math.max(Math.ceil(dataMatrixBBC.d_ijMax),Math.ceil(Math.abs(dataMatrixBBC.d_ijMin)));
    outlierRange.min = 0;
    outlierRange.value = outlierRange.max;
    outputOutlierRange.innerHTML = outlierRange.value;
    dataMatrixBBC.outlierLimit = outlierRange.value;
    
}


//sortedList.push([i,dataMatrixBBC.meanMidpointDist_i[i]]);
  //     if (indexValue == "meanADiff")
    //    sortedList.push([i,dataMatrixBBC.meanAngleDiff_i[i]]);


function generatePear() {
    
    var a1List = [];
    var a2List = [];
    var a3List = [];
    var a4List = [];
    
    var bList = [];
        
    
    for(i=0;i<a;i++) {
        var currentI = sortedList[i][0];

        a1List.push(dataMatrixBBC.meanYi[currentI]);
        //a2List.push(dataMatrixBBC.meanMidpointDist_i[currentI]);
        //a3List.push(dataMatrixBBC.meanAngleDiff_i[currentI]);
        //a4List.push(dataMatrixBBC.meanZposDist_i[currentI]);
        
        
        
        bList.push(dataMatrixBBC.meanYiSD[currentI]);
        
   
    }
    
    alertString = "The Pearson correlations between mean diameter, mean midpoint distance, mean z-position difference, and mean angle difference vs SD of the differences of observers from the mean:";
    alertString += "\r\n";
    alertString += "Mean diameter: r="+jStat.corrcoeff( a1List, bList );
    
    /*
    alertString += "\r\n";
    alertString += "Mean midpoint distance: r="+jStat.corrcoeff( a2List, bList );
    
    alertString += "\r\n";
    alertString += "Mean angle difference: r="+jStat.corrcoeff( a3List, bList );
    
    alertString += "\r\n";
    alertString += "Mean z-pos distance: r="+jStat.corrcoeff( a4List, bList );
    */
    
    console.log(alertString);
    alert(alertString);
    
    
}



// 







var subjectList;
//var subjectTable = document.getElementById("realTable3");

var subjectTable = document.getElementById("tableText3");


function populateSubjectTable() {
    subjectTable.innerHTML = "";
    for(i=0;i<subjectList.length;i++) {
        
        var innerH = "";
        
        /*
        var row = subjectTable.insertRow(subjectTable.rows.length);
        var cell1 = row.insertCell(0);
        */
        
        var currentI = sortedList[i][0];
        
        var token = subjectList[currentI];
        
        if (subjectList[currentI] == 1)
            token = "( locked )";
        else
            token = "";
    
        innerH = "<a href='javascript:toggleSubject(" + currentI + ")'>"+(i+1)+": Subject i="+(currentI)+" ("+dataKiTSID.data[currentI]+") "+token+" </a> (Mean: " + (Math.round(dataMatrixBBC.meanYi[currentI] * 100) / 100).toFixed(2) + " )";
        
        //cell1.innerHTML = "<a href='javascript:toggleSubject(" + currentI + ")'>"+(i+1)+": Subject i="+(currentI)+" "+token+" </a> (Mean: " + (Math.round(dataMatrixBBC.meanYi[currentI] * 100) / 100).toFixed(2) + " )";
        
        innerH += " SD: "+(Math.round(dataMatrixBBC.meanYiSD[currentI] * 100) / 100).toFixed(2);
        
      //  cell1.innerHTML += " SD: "+(Math.round(dataMatrixBBC.meanYiSD[currentI] * 100) / 100).toFixed(2);
        
        if (data3 != null && true) {
            
            innerH += " Mean angle diff: "+(Math.round(dataMatrixBBC.meanAngleDiff_i[currentI] * 100) / 100).toFixed(2);
            innerH += " Mean midpoint dist: "+(Math.round(dataMatrixBBC.meanMidpointDist_i[currentI] * 100) / 100).toFixed(2);
            
           // cell1.innerHTML += " Mean angle diff: "+(Math.round(dataMatrixBBC.meanAngleDiff_i[currentI] * 100) / 100).toFixed(2);
         //   cell1.innerHTML += " Mean midpoint dist: "+(Math.round(dataMatrixBBC.meanMidpointDist_i[currentI] * 100) / 100).toFixed(2);
            
            
        }
        
        if (data2 != null && true) {
        
        //innerH += "<a href='javascript:showAllScreenshots(" + currentI + ")'> ( Show screenshots ) </a>"; 
        //innerH += " </a><a href='javascript:openStudy(" + currentI + ")'>( Open study ) </a> ";
    
        }
    
        //cell1.innerHTML += "<a href='javascript:showAllScreenshots(" + currentI + ")'> ( Show screenshots ) </a>"; 
        //cell1.innerHTML += " </a><a href='javascript:openStudy(" + currentI + ")'>( Open study ) </a> ";
        
        if (i % 2 != 0)
            innerH = "<span style='background-color: lightgrey'>"+innerH + "</span>";
        
       subjectTable.innerHTML += innerH + "<br>";
        
    }
    
    
}





var observerList;
var observerTable = document.getElementById("tableText2");

function populateObserverTable() {
    observerTable.innerHTML = "";
    
   
    
    for(i=0;i<observerList.length;i++) {
        //var row = observerTable.insertRow(observerTable.rows.length);
        //var cell1 = row.insertCell(0);
        
        var token = observerList[i];
        
        if (observerList[i] == 1)
            token = "on";
        else
            token = "off";
    
        
        observerTable.innerHTML  += "<a href='javascript:toggleObserver(" + i + ")'>"+"Observer "+(i+1)+" ("+token+")</a><br>";
        
       
        
    }
    
    
    
}

//var realTableObserverInfo = document.getElementById("realTableObserverInfo");
var realTableObserverInfo = document.getElementById("tableText4");
function updateObserverTableInfo() {
    
    
    realTableObserverInfo.innerHTML = "";
    var tempHTML = "";
    var tempHTMLArray = new Array();
    sortedObservers = new Array();
    var indexValue = document.getElementById("sortByDropdownObservers").value;
    
     var i = 0;
    
    for(p=0;p<observerList.length;p++) {
        
        if (observerList[p] == 0)
            continue;
        
       
        var insertText = "<span style='color:" + dotColors[p] + "'>";
        
        if (clickSelectedObserver == i || plot.selectedObserver == i)
            insertText += "(+)";
        else
            insertText += "(-)";
            
        insertText += "</span>."+dataMatrixBBC[i][0][2]+"; Mean (j="+i+"): "+(Math.round(dataMatrixBBC.meanYj[i] * 100) / 100).toFixed(2)+" ("+(Math.round(dataMatrixBBC[i].SD * 100) / 100).toFixed(2)+"); Maximum: "+(Math.round(dataMatrixBBC[i].max * 100) / 100).toFixed(2)+"; Minimum: "+(Math.round(dataMatrixBBC[i].min * 100) / 100).toFixed(2);
    
        insertText += "; Mean difference: "+(Math.round(dataMatrixBBC[i].meanD_j * 100) / 100).toFixed(2);
   
        insertText = "<div style='cursor:pointer' onmouseout='updatePlotSelectedObserverOut(event)' onmousemove='updatePlotSelectedObserver(event,"+i+")' onmousedown='updateClickSelectedObserver(event,"+i+")'>" + insertText + "</div>";
        
        if (participant != "") {
            if (participant == p)
                insertText = "<b>"+insertText+"</b>";
        }
       
        
        tempHTMLArray.push(insertText)
        
            if (indexValue == "observer")
                sortedObservers.push([i,i]) 
            else if (indexValue == "meanDiff")
                sortedObservers.push([p,dataMatrixBBC[i].meanD_j]) 
            else if (indexValue == "mean")
                sortedObservers.push([p,dataMatrixBBC.meanYj[i]]) 
            else if (indexValue == "SDDiff")
                sortedObservers.push([p,dataMatrixBBC[i].SD]) 
        
        
        i++;
    }

    tempHTML = "";
    sortedObservers.sort((a,b) => a[1] - b[1]);
    for(h=0;h<tempHTMLArray.length;h++) {

        tempHTML += tempHTMLArray[sortedObservers[h][0]];
    
    }

    realTableObserverInfo.innerHTML += tempHTML + "";
    
    
}


function updateClickSelectedObserver(event,i) {
   // console.log(i);
    if (clickSelectedObserver == i)
        clickSelectedObserver = null;
    else
        clickSelectedObserver = i;

    
    updatePlot();
    updateObserverTableInfo();
    event.stopPropagation();
}

function updatePlotSelectedObserver(event,i) {
    if (moveGUI)
        return;
    
    plot.selectedObserver = i;
   // console.log(i);
    updateObserverTableInfo();
    updatePlot();
    event.stopPropagation();
    
}

function updatePlotSelectedObserverOut(event) {
    if (moveGUI)
        return;
    
    plot.selectedObserver = null;
    updateObserverTableInfo();
    updatePlot();
    event.stopPropagation();
    
}


function toggleObserver(no) {

if (observerList[no] == 1)
    observerList[no] = 0;
else
    observerList[no] = 1;


    populateObserverTable();
    
    clickSelectedObserver = null;
    
    
    preprocessing(); // her er problemet!
    can.dispatchEvent(new Event("mousemove"));
}

function toggleSubject(no) {

if (subjectList[no] == 1)
    subjectList[no] = 0;
else
    subjectList[no] = 1;

    populateSubjectTable();
    updatePlot();
    
    
}




var table = document.getElementById("tableText1"); 

var tableCounter = 0;
var tempHTML = "";
function myTableUpdater(text) {
  tableCounter++;
  /*
  var row = table.insertRow(table.rows.length);
  var cell1 = row.insertCell(0);

  cell1.innerHTML = "<span>"+text+"</span>";
  */
  
 /*
  if ((tableCounter % 2) == 0)
  table.innerHTML += "<span style='background-color: lightgrey'>"+text + "</span><br>";
  else
  table.innerHTML += text + "<br>";
  */
  
}

function tableDeleteRows() {
    table.innerHTML = "";
    
    
}







////////////////

//dataMatrixBBC.meanMidpointDist_i = new Array();
//dataMatrixBBC.meanAngleDiff_i = new Array();
function avgMidpointDist() {
  
    dataMatrixBBC.meanMidpointDist_i = new Array();
    dataMatrixBBC.meanAngleDiff_i = new Array();
    dataMatrixBBC.meanZposDist_i = new Array();
    
    
    var totalComparisons = c*Array(...Array(b).keys()).reduce((a, b) => a + b, 0);
   
    
    
    
    for(i=0;i<a;i++) {
    
        //dataMatrixBBC.meanMidpointDist_i[i] = Array(c).fill(0);
        //dataMatrixBBC.meanAngleDiff_i[i] = Array(c).fill(0);
        dataMatrixBBC.meanMidpointDist_i[i] = 0;
        dataMatrixBBC.meanAngleDiff_i[i] = 0;
        dataMatrixBBC.meanZposDist_i[i] = 0;
        
    var MA = 0;
    var MD = 0;
    
    for(l=0;l<b-1;l++) {
        
    for(p=l+1;p<b;p++) {
    
               for(k=0;k<c;k++) {
                    var first = dataMatrixBBC[l][i][4][k];
                    var second = dataMatrixBBC[p][i][4][k];
                    midpointDist = Math.pow(second[0]-first[0],2)+Math.pow(second[1]-first[1],2)+Math.pow(second[2]-first[2],2);
                    midpointDist = Math.sqrt(midpointDist);
                    
                    dataMatrixBBC.meanMidpointDist_i[i] = dataMatrixBBC.meanMidpointDist_i[i]+(midpointDist/(totalComparisons)); 
                    
                    var first = dataMatrixBBC[l][i][3][k];
                    var second = dataMatrixBBC[p][i][3][k];
                    
                    
                    angleDiff = Math.abs(first - second);
                    if (first*second > 0) {
                    angleDiff = Math.abs(first - second);
                    } else {
                        diff = 180-angleDiff;
                        if (diff < angleDiff)
                            angleDiff = diff;
                        
                    }
                    dataMatrixBBC.meanAngleDiff_i[i] = dataMatrixBBC.meanAngleDiff_i[i]+(angleDiff/(totalComparisons)); 
                    
                    
                    
                    
        
                    dataMatrixBBC.meanZposDist_i[i] = dataMatrixBBC.meanZposDist_i[i] + (Math.abs(dataMatrixBBC[l][i][5][k]-dataMatrixBBC[p][i][5][k])/totalComparisons);            
                    
                    MA += angleDiff/totalComparisons;
                    MD += midpointDist/totalComparisons;
                  
                    
            
               }
    
    }
    
    }
    
    }
    
    // beav
    var x = document.getElementById("sortByDropdown");
      var option = document.createElement("option");
      option.text = "Mean midpoint dist";
      option.value = "meanMDist";
      x.add(option, x.length);
    var x2 = document.getElementById("sortByDropdown");
      var option2 = document.createElement("option");
      option2.text = "Mean angle diff";
      option2.value = "meanADiff";
      x2.add(option2, x.length);
    
    
}




var maxLoA = 0;
var minLoA = 1000000;
var maxMeanDiff = 0;
var minMeanDiff = 1000000;

var meanLoA = [0,0,0]; // LL, UL, SD
var maxDLoA = [0,0,0];
var noClinically = 0;
var noBAOutliers = 0;
var UL_limits = [[],[],[]];
// jStat.stdev([1,2,3,4])









function countDiff() {
    var numPairs = 0;
    var numObs = 0;
    
    for(l=0;l<b-1;l++) {
    
    for(p=l+1;p<b;p++) {
    
        numPairs++;
        
        
        for(i=0;i<a;i++) {
        
        
        
            var diff = (dataMatrixBBC[l][i][0][0]-dataMatrixBBC[p][i][0][0]);
            //var diff = (dataMatrixBBC[l][i][0][0]-dataMatrixBBC[p][i][0][1]);
            
            if (Math.abs(diff) > 2) {
                console.log(l+" : "+p+" -- "+numPairs+" ::: "+dataMatrixBBC[l][i][0][0]+" - "+dataMatrixBBC[p][i][0][1]+" : "+diff);
            
                numObs++; 
            }
           
        
        
        }
        
        
        
    }
    
    }
    
    
    console.log(numPairs+" - "+numObs);
    
}


function countDiffIntra() {
    var numObs = 0;
    var numPairs = 0;
   
    for(l=0;l<b;l++) {
        numPairs++;
        for(i=0;i<a;i++) {
        
        
        
            var diff = dataMatrixBBC[l][i][0][0]-dataMatrixBBC[l][i][0][1];
            console.log(l+" : "+p+" -- "+numPairs+" ::: "+diff);
            if (Math.abs(diff) > 5)
                numObs++; 
           
        
        
        }
    
    }
    console.log(numPairs+" - "+numObs);
    
}

function generateLoAsIntra() {
    
    
    maxLoA = 0;
    minLoA = 1000000;
    
    
    maxMeanDiff = 0;
    minMeanDiff = 1000000;
    meanLoA = [0,0,0]; // LL, UL, SD
    maxDLoA = [0,0,0];
    UL_limits = [[],[],[]];
    
    var totalCount = 0;
    
    var interobserverTable = document.getElementById("realTableInterobserver");
    interobserverTable.innerHTML = "";
    
    for(l=0;l<b;l++) {
    
    
        console.log("Intra: "+l+" ");
        LoACalc(l,l, 1,totalCount,-100);
        totalCount++;
    
    
    }
    
    console.log("maxLoA: "+maxLoA);
    console.log("maxLoA: "+minLoA);
   
    console.log("maxMeanDiff: "+maxMeanDiff);
    console.log("maxDLoA: "+maxDLoA);
    console.log("noClinically: "+noClinically);
    
    
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "--------------------";
   
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "Mean difference (max/min): ("+(Math.round(maxMeanDiff * 100) / 100).toFixed(2)+"/"+(Math.round(minMeanDiff * 100) / 100).toFixed(2)+")";
   
    meanLoA = meanLoA.map(i => i / totalCount); 
    
    
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "Mean SD of differences (SD), range: "+(Math.round(meanLoA[2] * 100) / 100).toFixed(2)+ " (" + (Math.round(jStat.stdev(UL_limits[2]) * 100) / 100).toFixed(2) + "), ("+ (Math.round(minLoA * 100) / 100).toFixed(2) + " to "+ (Math.round(maxLoA * 100) / 100).toFixed(2) +")";
    
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "Mean lower limit LoA: "+ (Math.round(meanLoA[0] * 100) / 100).toFixed(2)+ " (" + (Math.round(jStat.min(UL_limits[0]) * 100) / 100).toFixed(2) + " to " + (Math.round(jStat.max(UL_limits[0]) * 100) / 100).toFixed(2) + "), SD: "+(Math.round(jStat.stdev(UL_limits[0]) * 100) / 100).toFixed(2);
    
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "Mean upper limit LoA: "+(Math.round(meanLoA[1] * 100) / 100).toFixed(2)+ " ("+(Math.round(jStat.min(UL_limits[1]) * 100) / 100).toFixed(2) + " to " + (Math.round(jStat.max(UL_limits[1]) * 100) / 100).toFixed(2)+"), SD: "+(Math.round(jStat.stdev(UL_limits[1]) * 100) / 100).toFixed(2);
    
    
    
}



function generateLoAsInter() {
    
    minLoA = 1000000;
    maxLoA = 0;
    maxMeanDiff = 0;
    minMeanDiff = 1000000;
    
    meanLoA = [0,0,0]; // LL, UL, SD
    maxDLoA = [0,0,0];
    UL_limits = [[],[],[]];
    
    
    var interobserverTable = document.getElementById("realTableInterobserver");
    interobserverTable.innerHTML = "";
    
    var totalCount = 0;
    for(l=0;l<b-1;l++) {
    
        for(p=l+1;p<b;p++) {
            console.log(l+" : "+p);
            totalCount++;
            
            LoACalc(l,p, -1, totalCount);
            
        }
        
    }
    
    
    
    
    meanLoA = meanLoA.map(i => i / totalCount); 
    
    
    
    
     var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "--------------------";
   
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "Mean difference (max/min): ("+(Math.round(maxMeanDiff * 100) / 100).toFixed(2)+"/"+(Math.round(minMeanDiff * 100) / 100).toFixed(2)+")";
   
    //meanLoA = meanLoA.map(i => i / totalCount); 
    
    
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    
     
    
    cell1.innerHTML = "Mean SD of differences (SD), range: "+(Math.round(meanLoA[2] * 100) / 100).toFixed(2)+ " (" + (Math.round(jStat.stdev(UL_limits[2]) * 100) / 100).toFixed(2) + "), ("+ (Math.round(minLoA * 100) / 100).toFixed(2) + " to "+ (Math.round(maxLoA * 100) / 100).toFixed(2) +")";
    
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "Mean lower limit LoA: "+ (Math.round(meanLoA[0] * 100) / 100).toFixed(2)+ " (" + (Math.round(jStat.min(UL_limits[0]) * 100) / 100).toFixed(2) + " to " + (Math.round(jStat.max(UL_limits[0]) * 100) / 100).toFixed(2) + "), SD: "+(Math.round(jStat.stdev(UL_limits[0]) * 100) / 100).toFixed(2);
    
    var row = interobserverTable.insertRow(0);
    var cell1 = row.insertCell(0);
    cell1.innerHTML = "Mean upper limit LoA: "+(Math.round(meanLoA[1] * 100) / 100).toFixed(2)+ " ("+(Math.round(jStat.min(UL_limits[1]) * 100) / 100).toFixed(2) + " to " + (Math.round(jStat.max(UL_limits[1]) * 100) / 100).toFixed(2)+"), SD: "+(Math.round(jStat.stdev(UL_limits[1]) * 100) / 100).toFixed(2);
    
    
      
       
       
    return;
    
    
    /*
    console.log("maxLoA: "+maxLoA);
    console.log("maxMeanDiff: "+maxMeanDiff);
    console.log("maxDLoA: "+maxDLoA);
    console.log("noClinically: "+noClinically);
    console.log("totalCount: "+totalCount);
    console.log("noBAOutliers: "+noBAOutliers);
    */
    
    
}



function LoACalc(obs, obs2, meaNo, totalCount) {
    
    
    
    var o1 = document.getElementById("observerDropdown").selectedIndex;
    var o2 = document.getElementById("observerDropdown2").selectedIndex;
    var k1 = document.getElementById("measurementDropdown").selectedIndex;
    var k2 = document.getElementById("measurementDropdown2").selectedIndex;
    
    
    if (obs > -1) {
        o1 = obs;
        o2 = obs2;
        
    }
    if (meaNo > -1) {
        k1 = 0;
        k2 = 1;
    }
    //k2=1;
    //k1=0;
    
    
    var meanDifference = 0;
    
      
    
    for(i=0;i<a;i++) {
            var diff = dataMatrixBBC[o2][i][0][k2]-dataMatrixBBC[o1][i][0][k1];
            meanDifference += diff;    
            if (Math.abs(diff) > 2)
                noBAOutliers++;
    }
  
    
    meanDifference = meanDifference / a;
    var SD = 0;
    for(i=0;i<a;i++) {
        
            var diff = dataMatrixBBC[o2][i][0][k2]-dataMatrixBBC[o1][i][0][k1];
            
            SD = SD + Math.pow(diff-meanDifference,2);      
        
           
        
        
    }
    SD = Math.sqrt(SD / (a-1));
    
    console.log(meanDifference+" +/- "+1.96*SD);
    
    
    if (totalCount == -1) // = one LoA pair
        document.getElementById("LoAResult").innerHTML = " " + (Math.round(meanDifference * 100) / 100).toFixed(2) + " +/- "+(Math.round(1.96*SD * 100) / 100).toFixed(2);
    
    
    
    if (SD > maxLoA)
         maxLoA = SD;
    if (SD < minLoA)
         minLoA = SD;
        
    if (Math.abs(meanDifference) > Math.abs(maxMeanDiff))
         maxMeanDiff = meanDifference;
    if (Math.abs(meanDifference) < Math.abs(minMeanDiff))
         minMeanDiff = meanDifference;
    if ((Math.abs(meanDifference)+1.96*SD) > maxDLoA[0]) {
         maxDLoA = [(Math.abs(meanDifference)+1.96*SD),meanDifference-1.96*SD,meanDifference+1.96*SD];
         
    }
    
    meanLoA[0] +=  meanDifference-1.96*SD;
    meanLoA[1] +=  meanDifference+1.96*SD;
    meanLoA[2] +=  SD;
    
    UL_limits[0].push(meanDifference-1.96*SD);
    UL_limits[1].push(meanDifference+1.96*SD);
    UL_limits[2].push(SD);
    
    
    
    if (((Math.abs(meanDifference)+1.96*SD) > 5)) {
        console.log("SampleMaxClinically: "+(Math.abs(meanDifference)+1.96*SD))
        noClinically++;
    }
         
         
         
    if (totalCount > -1) {    
    var interobserverTable = document.getElementById("realTableInterobserver");
    
        var row = interobserverTable.insertRow(interobserverTable.rows.length);
        var cell1 = row.insertCell(0);
        cell1.innerHTML = "#"+totalCount+" Observer "+(obs+1)+" vs Observer "+(obs2+1)+" : "+(Math.round(meanDifference * 100) / 100).toFixed(2)+" +/- (1.96 SD) "+(Math.round(1.96* SD * 100) / 100).toFixed(2);
       
    }   
    if (totalCount == -100) {    
    var interobserverTable = document.getElementById("realTableInterobserver");
    
        var row = interobserverTable.insertRow(interobserverTable.rows.length);
        var cell1 = row.insertCell(0);
        cell1.innerHTML = "#"+totalCount+" Observer "+(obs+1)+" vs Observer "+(obs2+1)+" : "+(Math.round(meanDifference * 100) / 100).toFixed(2)+" +/- (1.96 SD) "+(Math.round(1.96* SD * 100) / 100).toFixed(2);
       
    }   
         
    
}


function grandMeanCI() {



    
    var S_2 = (dataMatrixBBC.SIGMA_B_2/b)+(dataMatrixBBC.SIGMA_E_2/(a*b*c))+(dataMatrixBBC.SIGMA_A_2/(a));  
    return 1.96*Math.sqrt(S_2);
    
    
}

function pairedT() {
    var CTAmean = 0;
    var NCmean = 0;
    var meanDiff = 0;
    for(i=0;i<(b*1);i=i+1) {
        for(j=0;j<40;j++) {
            meanDiff = meanDiff+(parseFloat(data.data[j][i])-parseFloat(dataNC.data[j][i]))
            CTAmean = CTAmean+parseFloat(data.data[j][i]);
            NCmean = NCmean+parseFloat(dataNC.data[j][i]);
        }
        console.log(i);
    }
    meanDiff = meanDiff/240;
    var SE = 0;
    for(i=0;i<(b*1);i=i+1) {
        for(j=0;j<40;j++) {
            SE = SE+Math.pow(((parseFloat(data.data[j][i])-parseFloat(dataNC.data[j][i]))-meanDiff),2);
        }
        console.log(i);
    }
    var no = (b*a)
    SE = SE/(no*(no-1));
    SE = Math.sqrt(SE);
    CTAmean = CTAmean/(b*a);
    NCmean = NCmean/(b*a);
    
    console.log("MeanDiff: "+meanDiff) 
    console.log("SE: "+SE) 
    console.log("t: "+(meanDiff/SE)); 
    console.log("CTAmean: "+CTAmean);
    console.log("NCmean: "+NCmean);
}


function populateDropdown(noB, noC) {
  for(b=0;b<noB;b++) {   
      var x = document.getElementById("observerDropdown");
      var x2 = document.getElementById("observerDropdown2");
      
      
      var option = document.createElement("option");
       var option2 = document.createElement("option");
      option.text = "Observer "+(b+1);
      option2.text = "Observer "+(b+1);
      
      x.add(option, x.length);
      x2.add(option2, x2.length);
  }
  
  for(c=0;c<noC;c++) {
      
      var x = document.getElementById("measurementDropdown");
      var x2 = document.getElementById("measurementDropdown2");
      var option = document.createElement("option");
       var option2 = document.createElement("option");
       option.text = "Measurement #"+(c+1);
      option2.text = "Measurement #"+(c+1);
      x.add(option, x.length);
      x2.add(option2, x2.length);
  }
  
  
}

function getIndex() {
    
    var e = document.getElementById("observerDropdown");
    var ind = e.options[e.selectedIndex].text;
    return e.selectedIndex;
}

function toggleLoA() {
    
    document.getElementById("interObserverButton").innerHTML = "Interobserver agreement between pairs (n="+(b*(b-1)/2)+")";
    //document.getElementById("intraObserverButton").innerHTML = "Intraobserver agreement between pairs (n="+b+")";
    
    var e = document.getElementById("LoAField");
  
    if (e.style.visibility == "visible") { 
        e.style.visibility = "hidden";
        document.getElementById("LoAResult").innerHTML = "";
    }
    else
        e.style.visibility = "visible";
  
    e.style.left= ((window.innerWidth/2)-250)+"px";
  
}


function countAA() {
    counter = 0;
    for(i=0;i<dataMatrixBBC.meanYi.length;i++) {
        
        if (dataMatrixBBC.meanYi[i] >= 30)
            counter++;
    }
    alert(counter);
    
}


function showCalipersObserverSubject(j,i,v) {
    
    
    
}



function getScreenshot2(j,i,v) {
    
    var id;
    id = data2.data[j][i*c+v];
    
    createdImage = new Image();
	createdImage.src =  "screenshots/"+id+".jpg";
	
    createdImage.onload = function() {
          document.getElementById('imageBox').innerHTML = "";
        document.getElementById('imageBox').appendChild(createdImage);   
         
        document.getElementById('imageBox').style.left = 0+"px";
        document.getElementById('imageBox').style.top = 0+"px";
      
    }
    
}









function removeImageBox() {
    
    document.getElementById('imageBox').style.left = "-100000px";
    
}


function download(filename, text) {
    /*
    text2 = "";
    for(i=0;i<512;i++) {
        for(b=0;b<512;b++) {
        
            text2 = text2 + text[i*512+b] + ",";
        
        }
        text2 = text2.substring(0, text2.length - 1);
        text2 = text2 + "\n";
        
    }
    text2 = text2.substring(0, text2.length - 1);
    */
    
    headers = "";
    
    var output = "";
    
    headers = new Array("Mean","SDMeanDiff","MeanAngleDiff", "MeanMidPointDiff", "MeanZposDist");
    for(t=0;t<headers.length;t++)
        headers[t] = text+headers[t];
    
    output = headers.toString() + "\n";
    
    
    
    for(l=0;l<a;l++) {
        output += dataMatrixBBC.meanYi[l]+","+dataMatrixBBC.meanYiSD[l]+","+dataMatrixBBC.meanAngleDiff_i[l]+","+dataMatrixBBC.meanMidpointDist_i[l]+","+dataMatrixBBC.meanZposDist_i[l]+"\n";
    }    
    
    var pom = document.createElement('a');
    pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(output));
    pom.setAttribute('download', filename);

    if (document.createEvent) {
        var event = document.createEvent('MouseEvents');
        event.initEvent('click', true, true);
        pom.dispatchEvent(event);
    }
    else {
        pom.click();
    }
}



var outStr = "";
function generateList() {
    outStr = "";
    var counter = 0;
    for(i=0;i<50;i++) {
        console.log(dataMatrixBBC.meanYi[i]);
        if (parseFloat(dataMatrixBBC.meanYi[i]) <= 3.0) {
            outStr += "1";
            counter++;
        }
        else
            outStr += "0";
    }
    console.log(counter);
    console.log(outStr);
    
}

var kappaMatrix = [];
function kappaList() {
    var counter = 0;
    
    
    
    for(i=0;i<b;i++) {
        kappaMatrix[i] = new Array(a*c);
        for(j=0;j<a;j++) {
            for(k=0;k<c;k++) {
                if (dataMatrixBBC[i][j][0][k] < 3.5)
                kappaMatrix[i][j*c+k] = 0; 
                else if (dataMatrixBBC[i][j][0][k] > 3.5 && dataMatrixBBC[i][j][0][k] <= 7.0)
                kappaMatrix[i][j*c+k] = 1; 
                else if (dataMatrixBBC[i][j][0][k] > 7)
                kappaMatrix[i][j*c+k] = 2; 
                
                
                 
                counter++
                //console.log(counter+" : "+dataMatrixBBC[i][j][0][k]);
        
            }
            
        }
    }
    
    for(i=0;i<b;i++) {
        console.log(""+kappaMatrix[i]);
    }
    
    console.log(counter);
    
    
    
}

function kappaList2() {
    var counter = 0;
    
    var kappaString = "";
    
    for(j=0;j<a;j++) {
    
    for(i=0;i<b;i++) {
            for(k=0;k<1;k++) {
                if (dataMatrixBBC[i][j][0][k] < 3.5)
                kappaString += "0,"; 
                else if (dataMatrixBBC[i][j][0][k] > 3.5 && dataMatrixBBC[i][j][0][k] <= 7.0)
                kappaString += "1,"; 
                else if (dataMatrixBBC[i][j][0][k] > 7)
                kappaString += "2,"; 
                
                counter++
                
            }
            
        }
        kappaString = kappaString.slice(0, -1);
        kappaString += "\n";
    }
    
    
    console.log(counter);
    
    copyToClipboard(kappaString);
    
}

var noOccur;
function kappaList3() {
    var counter = 0;
    noOccur = [0,0,0,0]
    
    var kappaString = "";
    
    for(j=0;j<a;j++) {
    
    for(i=0;i<b;i++) {
            for(k=0;k<1;k++) {
                if (dataMatrixBBC[i][j][0][k] < 7.0) {
                kappaString += "0,"; 
                noOccur[0]++;
                }
                else if (dataMatrixBBC[i][j][0][k] >= 7.0 && dataMatrixBBC[i][j][0][k] <= 14.0) {
                kappaString += "1,"; 
                noOccur[1]++;
                }
                else if (dataMatrixBBC[i][j][0][k] > 14 && dataMatrixBBC[i][j][0][k] < 21.0) {
                kappaString += "2,"; 
                noOccur[2]++;
                }
                else if (dataMatrixBBC[i][j][0][k] >= 21.0) {
                kappaString += "3,"; 
                noOccur[3]++;
                }
                
                counter++
                
            }
            
        }
        kappaString = kappaString.slice(0, -1);
        kappaString += "\n";
    }
    
    
    console.log(counter);
    
    copyToClipboard(kappaString);
    
}

const copyToClipboard = str => {
  const el = document.createElement('textarea');  // Create a <textarea> element
  el.value = str;                                 // Set its value to the string that you want copied
  el.setAttribute('readonly', '');                // Make it readonly to be tamper-proof
  el.style.position = 'absolute';                 
  el.style.left = '-9999px';                      // Move outside the screen to make it invisible
  document.body.appendChild(el);                  // Append the <textarea> element to the HTML document
  const selected =            
    document.getSelection().rangeCount > 0        // Check if there is any content selected previously
      ? document.getSelection().getRangeAt(0)     // Store selection if found
      : false;                                    // Mark as false to know no selection existed before
  el.select();                                    // Select the <textarea> content
  document.execCommand('copy');                   // Copy - only works as a result of a user action (e.g. click events)
  document.body.removeChild(el);                  // Remove the <textarea> element
  if (selected) {                                 // If a selection existed before copying
    document.getSelection().removeAllRanges();    // Unselect everything on the HTML document
    document.getSelection().addRange(selected);   // Restore the original selection
  }
};

document.body.addEventListener('keydown', function (e) {
   
    removeImageBox();
    
});

</script>